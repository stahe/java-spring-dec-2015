
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Introduction au langage Java et à l'écosystème Spring au travers d'une étude de cas">
      
      
        <meta name="author" content="Serge Tahé">
      
      
        <link rel="canonical" href="https://stahe.github.io/java-spring-dec-2015/cours-securiser-lacces-a-un-service-web-avec-spring-security.html">
      
      
        <link rel="prev" href="td-creation-dun-client-pour-le-service-web.html">
      
      
        <link rel="next" href="td-securisation-du-serveur-web--json-des-elections.html">
      
      
        
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>16. [Cours] : Sécuriser l'accès à un service web avec Spring Security - Introduction au langage Java et à l'écosystème Spring au travers d'une étude de cas</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/focus.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#16-cours-securiser-lacces-a-un-service-web-avec-spring-security" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Introduction au langage Java et à l&#39;écosystème Spring au travers d&#39;une étude de cas" class="md-header__button md-logo" aria-label="Introduction au langage Java et à l'écosystème Spring au travers d'une étude de cas" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction au langage Java et à l'écosystème Spring au travers d'une étude de cas
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              16. [Cours] : Sécuriser l'accès à un service web avec Spring Security
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode sombre"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Passer au mode sombre" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Passer au mode clair"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Passer au mode clair" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/stahe/java-spring-dec-2015" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Introduction au langage Java et à l&#39;écosystème Spring au travers d&#39;une étude de cas" class="md-nav__button md-logo" aria-label="Introduction au langage Java et à l'écosystème Spring au travers d'une étude de cas" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Introduction au langage Java et à l'écosystème Spring au travers d'une étude de cas
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/stahe/java-spring-dec-2015" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="introduction.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-le-probleme.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. [TD] : Le problème
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-classes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. [TD] : Classes
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-architectures-en-couches.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. [TD] : Architectures en couches
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="cours-introduction-au-framework-spring.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. [Cours] : Introduction au framework Spring
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="cours-introduction-a-lapi-jdbc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. [Cours] : Introduction à l'API JDBC
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-implementation-de-la-couche-dao-du-td-avec-lapi-jdbc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. [TD] : Implémentation de la couche [DAO] du TD avec l'API JDBC
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-la-couche-metier.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. [TD] : La couche [metier]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-implementation-de-la-couche-ui-avec-un-programme-console.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. [TD] : Implémentation de la couche [ui] avec un programme console
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-implementation-de-la-couche-ui-avec-une-interface-swing.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. [TD] : Implémentation de la couche [ui] avec une interface Swing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="cours-gestion-des-bases-de-donnees-relationnelles-avec-spring-data.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    11. [Cours] : Gestion des bases de données relationnelles avec Spring Data
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-implementation-de-la-couche-dao-du-td-avec-spring-data.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    12. [TD] : Implémentation de la couche [DAO] du TD avec [Spring Data]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="cours-exposer-une-base-de-donnees-sur-le-web-avec-spring-mvc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    13. [Cours] : Exposer une base de données sur le web avec Spring MVC
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-exposition-sur-le-web-de-la-couche-metier.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    14. [TD] : Exposition sur le web de la couche [metier]
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-creation-dun-client-pour-le-service-web.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    15. [TD] : création d'un client pour le service web
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    16. [Cours] : Sécuriser l'accès à un service web avec Spring Security
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="cours-securiser-lacces-a-un-service-web-avec-spring-security.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    16. [Cours] : Sécuriser l'accès à un service web avec Spring Security
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#161-support" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.1. Support
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#162-la-place-de-spring-security-dans-une-application-web" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.2. La place de Spring Security dans une application Web
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#163-un-tutoriel-sur-spring-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.3. Un tutoriel sur Spring Security
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="16.3. Un tutoriel sur Spring Security">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1631-configuration-maven" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.3.1. Configuration Maven
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1632-les-vues-thymeleaf" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.3.2. Les vues Thymeleaf
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1633-configuration-spring-mvc" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.3.3. Configuration Spring MVC
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1634-configuration-spring-security" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.3.4. Configuration Spring Security
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1635-classe-executable" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.3.5. Classe exécutable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1636-tests-de-lapplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.3.6. Tests de l'application
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1637-conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.3.7. Conclusion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#164-mise-en-place-de-la-securite-sur-le-service-web-json-des-produits" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4. Mise en place de la sécurité sur le service web / json des produits
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="16.4. Mise en place de la sécurité sur le service web / json des produits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1641-la-base-de-donnees" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.1. La base de données
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1642-le-projet-eclipse" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.2. Le projet Eclipse
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1643-la-configuration-maven" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.3. La configuration Maven
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1644-les-nouvelles-entites-jpa" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.4. Les nouvelles entités [JPA]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1645-les-repositories" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.5. Les [repositories]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1646-les-classes-de-gestion-des-utilisateurs-et-des-roles" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.6. Les classes de gestion des utilisateurs et des rôles
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1647-la-configuration-du-projet" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.7. La configuration du projet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1648-tests-de-la-couche-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.8. Tests de la couche [DAO]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1649-tests-du-service-web" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.9. Tests du service web
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16410-une-url-dauthentification" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.10. Une URL d'authentification
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16411-conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.4.11. Conclusion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#165-un-client-programme-pour-le-service-web-json-securise" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.5. Un client programmé pour le service web / jSON sécurisé
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="16.5. Un client programmé pour le service web / jSON sécurisé">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#16501-la-classe-abstractdao" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.5.0.1. La classe [AbstractDao]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16502-linterface-idao" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.5.0.2. L'interface [IDao]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16503-la-classe-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.5.0.3. La classe [Dao]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16504-tests-unitaires-de-la-classe-dao" class="md-nav__link">
    <span class="md-ellipsis">
      
        16.5.0.4. Tests unitaires de la classe [Dao]
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-securisation-du-serveur-web--json-des-elections.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    17. [TD] : sécurisation du serveur web / jSON des élections
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="cours-gestion-des-acces-inter-domaines.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    18. [Cours] : Gestion des accès inter-domaines
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="td-elections-avec-des-requetes-inter-domaines.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    19. [TD] Elections avec des requêtes inter-domaines
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="programmation-asynchrone-avec-rxjava.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    20. Programmation asynchrone avec RxJava
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="conclusion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    21. Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="annexes.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    22. Annexes
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="16-cours-securiser-lacces-a-un-service-web-avec-spring-security">16. [Cours] : Sécuriser l'accès à un service web avec Spring Security</h1>
<p><strong>Mots clés</strong> : architecture multicouche, Spring, injection de dépendances, service web / jSON sécurisé, client / serveur</p>
<h2 id="161-support">16.1. Support</h2>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000DB0000009816BDC0B3.png" style="display:inline-block; margin:4px;width:4.06cm;height:2.82cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000E100000075F57A4DEE.png" style="display:inline-block; margin:4px;width:4.17cm;height:2.17cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Les projets de ce chapitre seront trouvés dans le dossier [support / chap-16]. Le script SQL sert à générer la base de données nécessaire aux tests.</p>
<h2 id="162-la-place-de-spring-security-dans-une-application-web">16.2. La place de Spring Security dans une application Web</h2>
<p>Situons Spring Security dans le développement d'une application Web. Le plus souvent, celle-ci sera bâtie sur une architecture multicouche telle que la suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000057D00000147B2236C80.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.189cm;" /></td></tr></table>

<ul>
<li>la couche [<strong>Spring Security</strong>] n'accorde l'accès à la couche [web] qu'aux utilisateurs autorisés.</li>
</ul>
<h2 id="163-un-tutoriel-sur-spring-security">16.3. Un tutoriel sur Spring Security</h2>
<p>Nous allons de nouveau importer un guide Spring en suivant les étapes 1 à 3 ci-dessous :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004A2000002E0C8AE7C87.png" style="display:inline-block; margin:4px;width:15.69cm;height:9.737cm;" /></td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000F5000000FD9BD31E82.png" style="display:inline-block; margin:4px;width:4.54cm;height:4.68cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Le projet se compose des éléments suivants :</p>
<ul>
<li>dans le dossier [templates], on trouve les pages HTML du projet ;</li>
<li>[Application] : est la classe exécutable du projet ;</li>
<li>[MvcConfig] : est la classe de configuration de Spring MVC ;</li>
<li>[WebSecurityConfig] : est la classe de configuration de Spring Security ;</li>
</ul>
<h3 id="1631-configuration-maven">16.3.1. Configuration Maven</h3>
<p>Le projet [3] est un projet Maven. Examinons son fichier [pom.xml] pour connaître ses dépendances :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">&lt;project</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><span class="w"> </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>gs-securing-web<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="nt">&lt;version&gt;</span>0.1.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="nt">&lt;parent&gt;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="nt">&lt;version&gt;</span>1.2.3.RELEASE<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="nt">&lt;/parent&gt;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="nt">&lt;dependencies&gt;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="cm">&lt;!-- tag::security[] --&gt;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">        </span><span class="cm">&lt;!-- end::security[] --&gt;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="nt">&lt;/dependencies&gt;</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">    </span><span class="nt">&lt;properties&gt;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">        </span><span class="nt">&lt;start-class&gt;</span>hello.Application<span class="nt">&lt;/start-class&gt;</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">    </span><span class="nt">&lt;/properties&gt;</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">    </span><span class="nt">&lt;build&gt;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">        </span><span class="nt">&lt;plugins&gt;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">            </span><span class="nt">&lt;plugin&gt;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">                </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">                </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">            </span><span class="nt">&lt;/plugin&gt;</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">        </span><span class="nt">&lt;/plugins&gt;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">    </span><span class="nt">&lt;/build&gt;</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="nt">&lt;/project&gt;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 10-14 : le projet est un projet Spring Boot ;</li>
<li>lignes 17-20 : dépendance sur le framework [Thymeleaf] ;</li>
<li>lignes 22-25 : dépendance sur le framework Spring Security ;</li>
</ul>
<h3 id="1632-les-vues-thymeleaf">16.3.2. Les vues Thymeleaf</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000B7000000654C02E8DD.png" style="display:inline-block; margin:4px;width:3.39cm;height:1.87cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>La vue [home.html] est la suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000146000000CD6E9E44F9.png" style="display:inline-block; margin:4px;width:5.609cm;height:3.528cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>    <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>    <span class="na">xmlns:sec</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity3&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Spring Security Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Welcome!<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>        Click <span class="p">&lt;</span><span class="nt">a</span> <span class="na">th:href</span><span class="o">=</span><span class="s">&quot;@{/hello}&quot;</span><span class="p">&gt;</span>here<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> to see a greeting.
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 12 : l'attribut [th:href="@{/hello}"] va générer l'attribut [href] de la balise [&lt;a&gt;]. La valeur [@{/hello}] va générer le chemin [&lt;context&gt;/hello] où [context] est le contexte de l'application web ;
Le code HTML généré est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="na">xmlns:sec</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity3&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Spring Security Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Welcome!<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>            Click
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/hello&quot;</span><span class="p">&gt;</span>here<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>            to see a greeting.
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div></td></tr></table></div>
<p>La vue [hello.html] est la suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000144000000D545362419.png" style="display:inline-block; margin:4px;width:5.609cm;height:3.528cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="na">xmlns:sec</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity3&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Hello World!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="p">&lt;</span><span class="nt">h1</span> <span class="na">th:inline</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="p">&gt;</span>Hello [[${#httpServletRequest.remoteUser}]]!<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">th:action</span><span class="o">=</span><span class="s">&quot;@{/logout}&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Sign Out&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 9 : L'attribut [th:inline="text"] va générer le texte de la balise [&lt;h1&gt;]. Ce texte contient une expression \$ qui doit être évaluée. L'élément [[\${#httpServletRequest.remoteUser}]] est la valeur de l'attribut [RemoteUser] de la requête HTTP courante. C'est le nom de l'utilisateur connecté ;</li>
<li>ligne 10 : un formulaire HTML. L'attribut [th:action="@{/logout}"] va générer l'attribut [action] de la balise [form]. La valeur [@{/logout}] va générer le chemin [&lt;context&gt;/logout] où [context] est le contexte de l'application web ;
Le code HTML généré est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="na">xmlns:sec</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity3&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Hello World!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Hello user!<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/logout&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Sign Out&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;b152e5b9-d1a4-4492-b89d-b733fe521c91&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 8 : la traduction de Hello [[\${#httpServletRequest.remoteUser}]]!;</li>
<li>ligne 9 :  la traduction de @{/logout} ;</li>
<li>ligne 11 : un champ caché appelé (attribut name) <strong>_csrf</strong> ;
La vue [login.html] est la suivante :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000146000000C2EE6CA80A.png" style="display:inline-block; margin:4px;width:5.609cm;height:3.341cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="na">xmlns:sec</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity3&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Spring Security Example<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${param.error}&quot;</span><span class="p">&gt;</span>Invalid username and password.<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${param.logout}&quot;</span><span class="p">&gt;</span>You have been logged out.<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a>    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">th:action</span><span class="o">=</span><span class="s">&quot;@{/login}&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a>            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span> User Name : <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;username&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>            <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>            <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span> Password: <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>            <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a>        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a>        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a>            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Sign In&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a>        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a>    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 9 : l'attribut [th:if="\${param.error}"] fait que la balise &lt;div&gt; ne sera générée que si l'URL qui affiche la page de login contient le paramètre [error] (http://context/login?error);</li>
<li>ligne 10 : l'attribut [th:if="\${param.logout}"] fait que la balise &lt;div&gt; ne sera générée que si l'URL qui affiche la page de login contient le paramètre [logout] (http://context/login?logout);</li>
<li>lignes 11-23 : un formulaire HTML ;</li>
<li>ligne 11 : le formulaire sera posté à l'URL [&lt;context&gt;/login] où &lt;context&gt; est le contexte de l'application web ;</li>
<li>ligne 13 : un champ de saisie nommé [username] ;</li>
<li>ligne 17 : un champ de saisie nommé [password] ;
Le code HTML généré est le suivant :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="cp">&lt;!DOCTYPE html&gt;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="na">xmlns:sec</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity3&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Spring Security Example <span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>            You have been logged out.
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/login&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a>            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>                <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>                    User Name :
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;username&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>                <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>                <span class="p">&lt;</span><span class="nt">label</span><span class="p">&gt;</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a>                    Password:
<a id="__codelineno-6-22" name="__codelineno-6-22"></a>                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a>                <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a>            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>            <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a>                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Sign In&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a>            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a>            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;ef809b0a-88b4-4db9-bc53-342216b77632&quot;</span> <span class="p">/&gt;</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a>        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a>    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div></td></tr></table></div>
<p>On notera ligne 28 que Thymeleaf a ajouté un champ caché nommé [_<strong>csrf</strong>].</p>
<h3 id="1633-configuration-spring-mvc">16.3.3. Configuration Spring MVC</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000F1000000A03D183103.png" style="display:inline-block; margin:4px;width:4.461cm;height:2.96cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>La classe [MvcConfig] configure le framework Spring MVC :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">hello</span><span class="p">;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.config.annotation.ViewControllerRegistry</span><span class="p">;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter</span><span class="p">;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="nd">@Configuration</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MvcConfig</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">WebMvcConfigurerAdapter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addViewControllers</span><span class="p">(</span><span class="n">ViewControllerRegistry</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">addViewController</span><span class="p">(</span><span class="s">&quot;/home&quot;</span><span class="p">).</span><span class="na">setViewName</span><span class="p">(</span><span class="s">&quot;home&quot;</span><span class="p">);</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">addViewController</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">).</span><span class="na">setViewName</span><span class="p">(</span><span class="s">&quot;home&quot;</span><span class="p">);</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">addViewController</span><span class="p">(</span><span class="s">&quot;/hello&quot;</span><span class="p">).</span><span class="na">setViewName</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">addViewController</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">).</span><span class="na">setViewName</span><span class="p">(</span><span class="s">&quot;login&quot;</span><span class="p">);</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 7 : l'annotation [@Configuration] fait de la classe [MvcConfig] une classe de configuration ;</li>
<li>ligne 8 : la classe [MvcConfig] étend la classe [WebMvcConfigurerAdapter] pour en redéfinir certaines méthodes ;</li>
<li>ligne 10 : redéfinition d'une méthode de la classe parent ;</li>
<li>lignes 11- 16 : la méthode [addViewControllers] permet d'associer des URL à des vues HTML. Les associations suivantes y sont faites :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">URL</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>vue</b></p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">/, /home</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/templates/home.html</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">/hello</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/templates/hello.html</p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">/login</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">/templates/login.html</p></td></tr></table>

<p>Le suffixe [html] et le dossier [templates] sont les valeurs par défaut utilisées par Thymeleaf. Elles peuvent être changées par configuration. Le dossier [templates] doit être à la racine du Classpath du projet :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000003E800000174E26E89AE.png" style="display:inline-block; margin:4px;width:13.229cm;height:4.921cm;" /></td></tr></table>

<p>Ci-dessus [1], les dossiers [java] et [resources] sont tous les deux des dossier source (source folders). Cela implique que leur contenu sera à la racine du Classpath du projet. Donc en [2], les dossiers [hello] et [templates] seront  à la racine du Classpath.</p>
<h3 id="1634-configuration-spring-security">16.3.4. Configuration Spring Security</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000F70000009ACD60BCC4.png" style="display:inline-block; margin:4px;width:4.57cm;height:2.85cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>La classe [WebSecurityConfig] configure le framework Spring Security :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">hello</span><span class="p">;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="p">;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="p">;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.servlet.configuration.EnableWebMvcSecurity</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="nd">@Configuration</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="nd">@EnableWebMvcSecurity</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSecurityConfig</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">WebSecurityConfigurerAdapter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">().</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/home&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">().</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">();</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">formLogin</span><span class="p">().</span><span class="na">loginPage</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">().</span><span class="na">and</span><span class="p">().</span><span class="na">logout</span><span class="p">().</span><span class="na">permitAll</span><span class="p">();</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">AuthenticationManagerBuilder</span><span class="w"> </span><span class="n">auth</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">        </span><span class="n">auth</span><span class="p">.</span><span class="na">inMemoryAuthentication</span><span class="p">().</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;USER&quot;</span><span class="p">);</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 9 : l'annotation [@Configuration] fait de la classe [WebSecurityConfig] une classe de configuration ;</li>
<li>ligne 10 : l'annotation [@EnableWebSecurity]  fait de la classe [WebSecurityConfig] une classe de configuration de Spring Security ;</li>
<li>ligne 11 : la classe [WebSecurity] étend la classe [WebSecurityConfigurerAdapter] pour en redéfinir certaines méthodes ;</li>
<li>ligne 12 : redéfinition d'une méthode de la classe parent ;</li>
<li>lignes 13- 16 : la méthode [configure(HttpSecurity http)] est redéfinie pour définir les droits d'accès aux différentes URL de l'application ;</li>
<li>ligne 14 : la méthode [http.authorizeRequests()] permet d'associer des URL à des droits d'accès. Les associations suivantes y sont faites :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">URL</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>régle</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>code</b></p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">/, /home</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">accès sans être authentifié</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">http.authorizeRequests().antMatchers("/", "/home").permitAll()</code></pre></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">autres URL</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">accès authentifié uniquement</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">http.anyRequest().authenticated();</code></pre></td></tr></table>

<ul>
<li>ligne 15 : définit la méthode d'authentification. L'authentification se fait via un formulaire d'URL [/login] accessible à tous [http.formLogin().loginPage("/login").permitAll()]. La déconnexion (logout) est également accessible à tous ;</li>
<li>lignes 19-21 : redéfinissent la méthode [configure(AuthenticationManagerBuilder auth)] qui gère les utilisateurs ;</li>
<li>ligne 20 : l'autentification se fait avec des utilisateurs définis en " dur " [auth.inMemoryAuthentication()]. Un utilisateur est ici défini avec le login [user], le mot de passe [password] et le rôle [USER]. On peut accorder les mêmes droits à des utilisateurs ayant le même rôle ;</li>
</ul>
<h3 id="1635-classe-executable">16.3.5. Classe exécutable</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000F70000009A7B7CF92B.png" style="display:inline-block; margin:4px;width:4.57cm;height:2.85cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>La classe [Application] est la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">hello</span><span class="p">;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.SpringApplication</span><span class="p">;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.ComponentScan</span><span class="p">;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="nd">@EnableAutoConfiguration</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="nd">@Configuration</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="nd">@ComponentScan</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Application</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">Application</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 8 : l'annotation [@EnableAutoConfiguration] demande à Spring Boot (ligne 3) de faire la configuration que le développeur n'aura pas fait explicitement ;</li>
<li>ligne 9 : fait de la classe [Application] une classe de configuration Spring ;</li>
<li>ligne 10 : demande le scan du dossier de la classe [Application] afin de rechercher des composants Spring. Les deux classes [MvcConfig] et [WebSecurityConfig] vont être ainsi découvertes car elles ont l'annotation [@Configuration] ;</li>
<li>ligne 13 : la méthode [main] de la classe exécutable ;</li>
<li>ligne 14 : la méthode statique [SpringApplication.run] est exécutée avec comme paramètre la classe de configuration [Application]. Nous avons déjà rencontré ce processus et nous savons que le serveur Tomcat embarqué dans les dépendances Maven du projet va être lancé et le projet déployé dessus. Nous avons vu que quatre URL étaient gérées [/, /home, /login, /hello] et que certaines étaient protégées par des droits d'accès.</li>
</ul>
<h3 id="1636-tests-de-lapplication">16.3.6. Tests de l'application</h3>
<p>Commençons par demander l'URL [/] qui est l'une des quatre URL acceptées. Elle est associée à la vue [/templates/home.html] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000143000000DCD3E5FF81.png" style="display:inline-block; margin:4px;width:5.98cm;height:4.069cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>L'URL demandée [/] est accessible à tous. C'est pourquoi nous l'avons obtenue. Le lien [here] est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>Click <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/hello&quot;</span><span class="p">&gt;</span>here<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span> to see a greeting.
</code></pre></div></td></tr></table></div>
<p>L'URL [/hello] va être demandée lorsqu'on va cliquer sur le lien. Celle-ci est protégée :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">URL</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>règle</b></p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>code</b></p></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">/, /home</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">accès sans être authentifié</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">http.authorizeRequests().antMatchers("/", "/home").permitAll()</code></pre></td></tr><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">autres URL</code></pre></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;">accès authentifié uniquement</p></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><pre><code class="language-text">http.anyRequest().authenticated();</code></pre></td></tr></table>

<p>Il faut être authentifié pour l'obtenir. Spring Security va alors rediriger le navigateur client vers la page d'authentification. D'après la configuration vue, c'est la page d'URL [/login]. Celle-ci est accessible à tous :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a>http.formLogin().loginPage(&quot;/login&quot;).permitAll().and().logout().permitAll();
</code></pre></div></td></tr></table></div>
<p>Nous l'obtenons donc [1] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000498000001441DE29479.png" style="display:inline-block; margin:4px;width:15.558cm;height:4.286cm;" /></td></tr></table>

<p>Le code source de la page obtenue est le suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a>&lt;!DOCTYPE html&gt;
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:sec=&quot;http://www.thymeleaf.org/thymeleaf-extras-springsecurity3&quot;&gt;
<a id="__codelineno-12-4" name="__codelineno-12-4"></a>...
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>    &lt;form method=&quot;post&quot; action=&quot;/login&quot;&gt;
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>...
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>       &lt;input type=&quot;hidden&quot; name=&quot;_csrf&quot; value=&quot;87bea06a-a177-459d-b279-c6068a7ad3eb&quot; /&gt;
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>   &lt;/form&gt;
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>&lt;/body&gt;
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>&lt;/html&gt;
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 7, un champ caché apparaît qui n'est pas dans la page [login.html] d'origine. C'est Thymeleaf qui l'a ajouté. Ce code appelé CSRF (Cross Site Request Forgery) vise à éliminer une faille de sécurité. Ce jeton doit être renvoyé à Spring Security avec l'authentification pour que cette dernière soit acceptée ;
Nous nous souvenons que seul l'utilisateur user/password est reconnu par Spring Security. Si nous entrons autre chose en [2], nous obtenons la même page avec un message d'erreur en [3]. Spring Security a redirigé le navigateur vers l'URL [http://localhost:8080/login?error]. La présence du paramètre [error] a déclenché l'affichage de la balise :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${param.error}&quot;</span><span class="p">&gt;</span>Invalid username and password.<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div></td></tr></table></div>
<p>Maintenant, entrons les valeurs attendues user/password [4] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000048900000147D6AF35A2.png" style="display:inline-block; margin:4px;width:15.36cm;height:4.327cm;" /></td></tr></table>

<ul>
<li>en [4], nous nous identifions ;</li>
<li>en [5], Spring Security nous redirige vers l'URL [/hello] car c'est l'URL que nous demandions lorsque nous avons été redirigés vers la page de login. L'identité de l'utilisateur a été affichée par la ligne suivante de [hello.html] :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="w">    </span><span class="o">&lt;</span><span class="nx">h1</span><span class="w"> </span><span class="nx">th</span><span class="o">:</span><span class="nx">inline</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="w"> </span><span class="p">[[</span><span class="nx">$</span><span class="p">{</span><span class="n">#httpServletRequest</span><span class="p">.</span><span class="nx">remoteUser</span><span class="p">}]]</span><span class="o">!&lt;</span><span class="err">/h1&gt;</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>La page [5] affiche le formulaire suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a>    &lt;form th:action=&quot;@{/logout}&quot; method=&quot;post&quot;&gt;
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>        &lt;input type=&quot;submit&quot; value=&quot;Sign Out&quot; /&gt;
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>&lt;/form&gt;
</code></pre></div></td></tr></table></div>
<p>Lorsqu'on clique sur le bouton [Sign Out], un POST va être fait sur l'URL [/logout]. Celle-ci comme l'URL [/login] est accessible à tous :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>http.formLogin().loginPage(&quot;/login&quot;).permitAll().and().logout().permitAll();
</code></pre></div></td></tr></table></div>
<p>Dans notre association URL / vues, nous n'avons rien défini pour l'URL [/logout]. Que va-t-il se passer ? Essayons :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004B70000015550E2A552.png" style="display:inline-block; margin:4px;width:15.968cm;height:4.512cm;" /></td></tr></table>

<ul>
<li>en [6], nous cliquons sur le bouton [Sign Out] ;</li>
<li>en [7], nous voyons que nous avons été redirigés vers l'URL [http://localhost:8080/login?logout]. C'est Spring Security qui a demandé cette redirection. La présence du paramètre [logout] dans l'URL a fait afficher la ligne suivante de la vue :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${param.logout}&quot;</span><span class="p">&gt;</span>You have been logged out.<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<h3 id="1637-conclusion">16.3.7. Conclusion</h3>
<p>Dans l'exemple précédent, nous aurions pu écrire l'application web d'abord puis la sécuriser ensuite. Spring Security n'est pas intrusif. On peut mettre en place la sécurité d'une application web déjà écrite. Par ailleurs, nous avons découvert les points suivants :</p>
<ul>
<li>il est possible de définir une page d'authentification ;</li>
<li>l'authentification doit être accompagnée du jeton CSRF délivré par Spring Security ;</li>
<li>si l'authentification échoue, on est redirigé vers la page d'authentification avec de plus un paramètre <strong>error</strong> dans l'URL ;</li>
<li>si l'authentification réussit, on est redirigé vers la page demandée lorsque l'authentification a eu lieu. Si on demande directement la page d'authentification sans passer par une page intermédiaire, alors Spring Security nous redirige vers l'URL [/] (ce cas n'a pas été présenté) ;</li>
<li>on se déconnecte en demandant l'URL [/logout] avec un POST. Spring Security nous redirige alors vers la page d'authentification avec le paramètre <strong>logout</strong> dans l'URL ;
Toutes ces conclusions reposent sur des comportements par défaut de Spring Security. Ces comportements peuvent être changés par configuration en redéfinissant certaines méthodes de la classe [WebSecurityConfigurerAdapter].</li>
</ul>
<p>Le tutoriel précédent nous aidera peu dans la suite. Nous allons en effet utiliser :</p>
<ul>
<li>une base de données pour stocker les utilisateurs, leurs mots de passe et leurs rôles ;</li>
<li>une authentification par entête HTTP ;
On trouve assez peu de tutoriels pour ce qu'on veut faire ici. La solution qui va être proposée est un assemblage de codes trouvés ici et là.</li>
</ul>
<h2 id="164-mise-en-place-de-la-securite-sur-le-service-web-json-des-produits">16.4. Mise en place de la sécurité sur le service web / json des produits</h2>
<h3 id="1641-la-base-de-donnees">16.4.1. La base de données</h3>
<p>La base de données [dbintrospringdata] évolue pour prendre en compte les utilisateurs, leurs mots de passe et leur rôles. Trois nouvelles tables apparaissent :</p>
<p><img src="images/1000000000000295000000BEB9405F01.png" style="width:12.24cm;height:3.521cm;" alt="Image" /></p>
<p><strong>Table [USERS] : les utilisateurs</strong></p>
<ul>
<li>ID : clé primaire ;</li>
<li>VERSION : colonne de versioning de la ligne ;</li>
<li>IDENTITY : une identité descriptive de l'utilisateur ;</li>
<li>LOGIN : le login de l'utilisateur ;</li>
<li>PASSWORD : son mot de passe ;
Dans la table USERS, les mots de passe ne sont pas stockés en clair :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000025B00000088CAEA4E9C.png" style="display:inline-block; margin:4px;width:11.171cm;height:2.521cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>L'algorithme qui crypte les mots de passe est l'algorithme BCRYPT.</p>
<p><strong>Table [ROLES] : les rôles</strong></p>
<ul>
<li>ID : clé primaire ;</li>
<li>VERSION : colonne de versioning de la ligne ;</li>
<li>NAME : nom du rôle. Par défaut, Spring Security attend des noms de la forme ROLE_XX, par exemple ROLE_ADMIN ou ROLE_GUEST ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000B500000048E262A78D.png" style="display:inline-block; margin:4px;width:3.35cm;height:1.33cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p><strong>Table [USERS_ROLES] : table de jointure USERS / ROLES</strong></p>
<p>Un utilisateur peut avoir plusieurs rôles, un rôle peut rassembler plusieurs utilisateurs. On a une relation <strong>plusieurs à plusieurs</strong> matérialisée par la table [USERS_ROLES].</p>
<ul>
<li>ID : clé primaire ;</li>
<li>VERSION : colonne de versioning de la ligne ;</li>
<li>USER_ID : identifiant d'un utilisateur ;</li>
<li>ROLE_ID : identifiant d'un rôle ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000D70000004EAD3A1F94.png" style="display:inline-block; margin:4px;width:3.979cm;height:1.439cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<h3 id="1642-le-projet-eclipse">16.4.2. Le projet Eclipse</h3>
<p>Nous créons le projet Eclipse suivant :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>1</b></p><img src="images/1000000000000118000000B9B4B6008E.png" style="display:inline-block; margin:4px;width:5.181cm;height:3.431cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<ul>
<li>en [1] : le nouveau projet avec les paquetages suivants :</li>
<li>[spring.security.entities] : contient les entités JPA correspondant aux trois nouvelles tables de la base de données ;</li>
<li>[spring.security.repositories] : contient les [repositories] de Spring Data associés  aux trois nouvelles tables ;</li>
<li>[spring.security.dao] : contient un service s'appuyant sur les [repositories] ;</li>
<li>[spring.security.config] : contient la configuration du projet et notamment celle des accès sécurisés au service web ;</li>
<li>[spring.security.boot] : conteint la classe de lancement du service web sécurisé ;</li>
</ul>
<h3 id="1643-la-configuration-maven">16.4.3. La configuration Maven</h3>
<p>Le nouveau projet est un projet Maven configuré par le fichier [pom.xml] suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span>
<span class="normal"><a href="#__codelineno-18-38">38</a></span>
<span class="normal"><a href="#__codelineno-18-39">39</a></span>
<span class="normal"><a href="#__codelineno-18-40">40</a></span>
<span class="normal"><a href="#__codelineno-18-41">41</a></span>
<span class="normal"><a href="#__codelineno-18-42">42</a></span>
<span class="normal"><a href="#__codelineno-18-43">43</a></span>
<span class="normal"><a href="#__codelineno-18-44">44</a></span>
<span class="normal"><a href="#__codelineno-18-45">45</a></span>
<span class="normal"><a href="#__codelineno-18-46">46</a></span>
<span class="normal"><a href="#__codelineno-18-47">47</a></span>
<span class="normal"><a href="#__codelineno-18-48">48</a></span>
<span class="normal"><a href="#__codelineno-18-49">49</a></span>
<span class="normal"><a href="#__codelineno-18-50">50</a></span>
<span class="normal"><a href="#__codelineno-18-51">51</a></span>
<span class="normal"><a href="#__codelineno-18-52">52</a></span>
<span class="normal"><a href="#__codelineno-18-53">53</a></span>
<span class="normal"><a href="#__codelineno-18-54">54</a></span>
<span class="normal"><a href="#__codelineno-18-55">55</a></span>
<span class="normal"><a href="#__codelineno-18-56">56</a></span>
<span class="normal"><a href="#__codelineno-18-57">57</a></span>
<span class="normal"><a href="#__codelineno-18-58">58</a></span>
<span class="normal"><a href="#__codelineno-18-59">59</a></span>
<span class="normal"><a href="#__codelineno-18-60">60</a></span>
<span class="normal"><a href="#__codelineno-18-61">61</a></span>
<span class="normal"><a href="#__codelineno-18-62">62</a></span>
<span class="normal"><a href="#__codelineno-18-63">63</a></span>
<span class="normal"><a href="#__codelineno-18-64">64</a></span>
<span class="normal"><a href="#__codelineno-18-65">65</a></span>
<span class="normal"><a href="#__codelineno-18-66">66</a></span>
<span class="normal"><a href="#__codelineno-18-67">67</a></span>
<span class="normal"><a href="#__codelineno-18-68">68</a></span>
<span class="normal"><a href="#__codelineno-18-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="nt">&lt;project</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><span class="w"> </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>istia.st.spring.security<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>intro-spring-security-server-01<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="nt">&lt;name&gt;</span>intro-spring-security-server-01<span class="nt">&lt;/name&gt;</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="nt">&lt;description&gt;</span>démo<span class="w"> </span>spring<span class="w"> </span>security<span class="nt">&lt;/description&gt;</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">    </span><span class="nt">&lt;properties&gt;</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">        </span><span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">        </span><span class="nt">&lt;java.version&gt;</span>1.8<span class="nt">&lt;/java.version&gt;</span>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">    </span><span class="nt">&lt;/properties&gt;</span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a>
<a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">    </span><span class="nt">&lt;parent&gt;</span>
<a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-18-18" name="__codelineno-18-18"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="w">        </span><span class="nt">&lt;version&gt;</span>1.2.7.RELEASE<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-18-20" name="__codelineno-18-20"></a><span class="w">    </span><span class="nt">&lt;/parent&gt;</span>
<a id="__codelineno-18-21" name="__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="w">    </span><span class="nt">&lt;dependencies&gt;</span>
<a id="__codelineno-18-23" name="__codelineno-18-23"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>istia.st.webjson<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-18-25" name="__codelineno-18-25"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>intro-server-webjson-01<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-18-26" name="__codelineno-18-26"></a><span class="w">            </span><span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-18-27" name="__codelineno-18-27"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-18-28" name="__codelineno-18-28"></a><span class="w">        </span><span class="cm">&lt;!-- Spring security --&gt;</span>
<a id="__codelineno-18-29" name="__codelineno-18-29"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-18-30" name="__codelineno-18-30"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-18-31" name="__codelineno-18-31"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-18-32" name="__codelineno-18-32"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-18-33" name="__codelineno-18-33"></a><span class="w">        </span><span class="cm">&lt;!-- Spring logs --&gt;</span>
<a id="__codelineno-18-34" name="__codelineno-18-34"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-18-35" name="__codelineno-18-35"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-18-36" name="__codelineno-18-36"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-logging<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-18-37" name="__codelineno-18-37"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-18-38" name="__codelineno-18-38"></a><span class="w">        </span><span class="cm">&lt;!-- Spring Boot --&gt;</span>
<a id="__codelineno-18-39" name="__codelineno-18-39"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-18-40" name="__codelineno-18-40"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-18-41" name="__codelineno-18-41"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>spring-boot<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-18-42" name="__codelineno-18-42"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-18-43" name="__codelineno-18-43"></a><span class="w">        </span><span class="cm">&lt;!-- Spring Boot Test --&gt;</span>
<a id="__codelineno-18-44" name="__codelineno-18-44"></a><span class="w">        </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-18-45" name="__codelineno-18-45"></a><span class="w">            </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-18-46" name="__codelineno-18-46"></a><span class="w">            </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-18-47" name="__codelineno-18-47"></a><span class="w">            </span><span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-18-48" name="__codelineno-18-48"></a><span class="w">        </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-18-49" name="__codelineno-18-49"></a><span class="w">    </span><span class="nt">&lt;/dependencies&gt;</span>
<a id="__codelineno-18-50" name="__codelineno-18-50"></a><span class="w">    </span><span class="cm">&lt;!-- plugins --&gt;</span>
<a id="__codelineno-18-51" name="__codelineno-18-51"></a><span class="w">    </span><span class="nt">&lt;build&gt;</span>
<a id="__codelineno-18-52" name="__codelineno-18-52"></a><span class="w">        </span><span class="nt">&lt;plugins&gt;</span>
<a id="__codelineno-18-53" name="__codelineno-18-53"></a><span class="w">            </span><span class="nt">&lt;plugin&gt;</span>
<a id="__codelineno-18-54" name="__codelineno-18-54"></a><span class="w">                </span><span class="nt">&lt;artifactId&gt;</span>maven-assembly-plugin<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-18-55" name="__codelineno-18-55"></a><span class="w">                </span><span class="nt">&lt;configuration&gt;</span>
<a id="__codelineno-18-56" name="__codelineno-18-56"></a><span class="w">                    </span><span class="nt">&lt;descriptorRefs&gt;</span>
<a id="__codelineno-18-57" name="__codelineno-18-57"></a><span class="w">                        </span><span class="nt">&lt;descriptorRef&gt;</span>jar-with-dependencies<span class="nt">&lt;/descriptorRef&gt;</span>
<a id="__codelineno-18-58" name="__codelineno-18-58"></a><span class="w">                    </span><span class="nt">&lt;/descriptorRefs&gt;</span>
<a id="__codelineno-18-59" name="__codelineno-18-59"></a><span class="w">                </span><span class="nt">&lt;/configuration&gt;</span>
<a id="__codelineno-18-60" name="__codelineno-18-60"></a><span class="w">            </span><span class="nt">&lt;/plugin&gt;</span>
<a id="__codelineno-18-61" name="__codelineno-18-61"></a><span class="w">            </span><span class="nt">&lt;plugin&gt;</span>
<a id="__codelineno-18-62" name="__codelineno-18-62"></a><span class="w">                </span><span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-18-63" name="__codelineno-18-63"></a><span class="w">                </span><span class="nt">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-18-64" name="__codelineno-18-64"></a><span class="w">                </span><span class="nt">&lt;version&gt;</span>2.18.1<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-18-65" name="__codelineno-18-65"></a><span class="w">            </span><span class="nt">&lt;/plugin&gt;</span>
<a id="__codelineno-18-66" name="__codelineno-18-66"></a><span class="w">        </span><span class="nt">&lt;/plugins&gt;</span>
<a id="__codelineno-18-67" name="__codelineno-18-67"></a><span class="w">    </span><span class="nt">&lt;/build&gt;</span>
<a id="__codelineno-18-68" name="__codelineno-18-68"></a>
<a id="__codelineno-18-69" name="__codelineno-18-69"></a><span class="nt">&lt;/project&gt;</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 23-27 : on reprend l'existant avec l'archive du service web / json étudié ;</li>
<li>lignes 29-32 : la dépendance qui amène les classes de Spring Security ;</li>
<li>lignes 34-37 : la bibliothèque de logs ;</li>
<li>lignes 39-42 : la bibliothèque permettant d'utiliser les annotations Spring Boot ;</li>
<li>lignes 44-48 : la bibliothèque nécessaire aux tests ;</li>
</ul>
<h3 id="1644-les-nouvelles-entites-jpa">16.4.4. Les nouvelles entités [JPA]</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000042C000000F0DB12BAF6.png" style="display:inline-block; margin:4px;width:14.129cm;height:3.175cm;" /></td></tr></table>

<p>La couche JPA définit trois nouvelles entités :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000AB0000004AD11DDC6D.png" style="display:inline-block; margin:4px;width:3.17cm;height:1.371cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>La classe [User] est l'image de la table [USERS] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span>
<span class="normal"><a href="#__codelineno-19-32">32</a></span>
<span class="normal"><a href="#__codelineno-19-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.entities</span><span class="p">;</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.Column</span><span class="p">;</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.Entity</span><span class="p">;</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.Table</span><span class="p">;</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.data.entities.AbstractEntity</span><span class="p">;</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="nd">@Entity</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;USERS&quot;</span><span class="p">)</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractEntity</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="w">    </span><span class="c1">// propriétés</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;NAME&quot;</span><span class="p">)</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;LOGIN&quot;</span><span class="p">)</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">login</span><span class="p">;</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;PASSWORD&quot;</span><span class="p">)</span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="w">    </span><span class="c1">// constructeur</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">User</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">User</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">login</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">login</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">login</span><span class="p">;</span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="w">    </span><span class="c1">// getters et setters</span>
<a id="__codelineno-19-32" name="__codelineno-19-32"></a><span class="p">...</span>
<a id="__codelineno-19-33" name="__codelineno-19-33"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 11 : la classe étend la classe [AbstractEntity] déjà utilisée pour les autres entités ;
La classe [Role] est l'image de la table [ROLES] :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span>
<span class="normal"><a href="#__codelineno-20-21">21</a></span>
<span class="normal"><a href="#__codelineno-20-22">22</a></span>
<span class="normal"><a href="#__codelineno-20-23">23</a></span>
<span class="normal"><a href="#__codelineno-20-24">24</a></span>
<span class="normal"><a href="#__codelineno-20-25">25</a></span>
<span class="normal"><a href="#__codelineno-20-26">26</a></span>
<span class="normal"><a href="#__codelineno-20-27">27</a></span>
<span class="normal"><a href="#__codelineno-20-28">28</a></span>
<span class="normal"><a href="#__codelineno-20-29">29</a></span>
<span class="normal"><a href="#__codelineno-20-30">30</a></span>
<span class="normal"><a href="#__codelineno-20-31">31</a></span>
<span class="normal"><a href="#__codelineno-20-32">32</a></span>
<span class="normal"><a href="#__codelineno-20-33">33</a></span>
<span class="normal"><a href="#__codelineno-20-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.entities</span><span class="p">;</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.Column</span><span class="p">;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.Entity</span><span class="p">;</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.Table</span><span class="p">;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.data.entities.AbstractEntity</span><span class="p">;</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="nd">@Entity</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROLES&quot;</span><span class="p">)</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Role</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractEntity</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">    </span><span class="c1">// propriétés</span>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;NAME&quot;</span><span class="p">)</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="w">    </span><span class="c1">// constructeurs</span>
<a id="__codelineno-20-18" name="__codelineno-20-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Role</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-19" name="__codelineno-20-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-20" name="__codelineno-20-20"></a>
<a id="__codelineno-20-21" name="__codelineno-20-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Role</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-22" name="__codelineno-20-22"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-20-23" name="__codelineno-20-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-24" name="__codelineno-20-24"></a>
<a id="__codelineno-20-25" name="__codelineno-20-25"></a><span class="w">    </span><span class="c1">// getters et setters</span>
<a id="__codelineno-20-26" name="__codelineno-20-26"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-27" name="__codelineno-20-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-20-28" name="__codelineno-20-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-29" name="__codelineno-20-29"></a>
<a id="__codelineno-20-30" name="__codelineno-20-30"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-31" name="__codelineno-20-31"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-20-32" name="__codelineno-20-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-33" name="__codelineno-20-33"></a>
<a id="__codelineno-20-34" name="__codelineno-20-34"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La classe [UserRole] est l'image de la table [USERS_ROLES] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span>
<span class="normal"><a href="#__codelineno-21-18">18</a></span>
<span class="normal"><a href="#__codelineno-21-19">19</a></span>
<span class="normal"><a href="#__codelineno-21-20">20</a></span>
<span class="normal"><a href="#__codelineno-21-21">21</a></span>
<span class="normal"><a href="#__codelineno-21-22">22</a></span>
<span class="normal"><a href="#__codelineno-21-23">23</a></span>
<span class="normal"><a href="#__codelineno-21-24">24</a></span>
<span class="normal"><a href="#__codelineno-21-25">25</a></span>
<span class="normal"><a href="#__codelineno-21-26">26</a></span>
<span class="normal"><a href="#__codelineno-21-27">27</a></span>
<span class="normal"><a href="#__codelineno-21-28">28</a></span>
<span class="normal"><a href="#__codelineno-21-29">29</a></span>
<span class="normal"><a href="#__codelineno-21-30">30</a></span>
<span class="normal"><a href="#__codelineno-21-31">31</a></span>
<span class="normal"><a href="#__codelineno-21-32">32</a></span>
<span class="normal"><a href="#__codelineno-21-33">33</a></span>
<span class="normal"><a href="#__codelineno-21-34">34</a></span>
<span class="normal"><a href="#__codelineno-21-35">35</a></span>
<span class="normal"><a href="#__codelineno-21-36">36</a></span>
<span class="normal"><a href="#__codelineno-21-37">37</a></span>
<span class="normal"><a href="#__codelineno-21-38">38</a></span>
<span class="normal"><a href="#__codelineno-21-39">39</a></span>
<span class="normal"><a href="#__codelineno-21-40">40</a></span>
<span class="normal"><a href="#__codelineno-21-41">41</a></span>
<span class="normal"><a href="#__codelineno-21-42">42</a></span>
<span class="normal"><a href="#__codelineno-21-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.entities</span><span class="p">;</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.Column</span><span class="p">;</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.Entity</span><span class="p">;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.JoinColumn</span><span class="p">;</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.ManyToOne</span><span class="p">;</span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">javax.persistence.Table</span><span class="p">;</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.data.entities.AbstractEntity</span><span class="p">;</span>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="nd">@Entity</span>
<a id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;USERS_ROLES&quot;</span><span class="p">)</span>
<a id="__codelineno-21-13" name="__codelineno-21-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserRole</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractEntity</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-14" name="__codelineno-21-14"></a>
<a id="__codelineno-21-15" name="__codelineno-21-15"></a><span class="w">    </span><span class="c1">// les clés étrangères</span>
<a id="__codelineno-21-16" name="__codelineno-21-16"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;USER_ID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">insertable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span>
<a id="__codelineno-21-18" name="__codelineno-21-18"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROLE_ID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">insertable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">updatable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-21-19" name="__codelineno-21-19"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">roleId</span><span class="p">;</span>
<a id="__codelineno-21-20" name="__codelineno-21-20"></a>
<a id="__codelineno-21-21" name="__codelineno-21-21"></a><span class="w">    </span><span class="c1">// un UserRole référence un User</span>
<a id="__codelineno-21-22" name="__codelineno-21-22"></a><span class="w">    </span><span class="nd">@ManyToOne</span>
<a id="__codelineno-21-23" name="__codelineno-21-23"></a><span class="w">    </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;USER_ID&quot;</span><span class="p">)</span>
<a id="__codelineno-21-24" name="__codelineno-21-24"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>
<a id="__codelineno-21-25" name="__codelineno-21-25"></a>
<a id="__codelineno-21-26" name="__codelineno-21-26"></a><span class="w">    </span><span class="c1">// un UserRole référence un Role</span>
<a id="__codelineno-21-27" name="__codelineno-21-27"></a><span class="w">    </span><span class="nd">@ManyToOne</span>
<a id="__codelineno-21-28" name="__codelineno-21-28"></a><span class="w">    </span><span class="nd">@JoinColumn</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ROLE_ID&quot;</span><span class="p">)</span>
<a id="__codelineno-21-29" name="__codelineno-21-29"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Role</span><span class="w"> </span><span class="n">role</span><span class="p">;</span>
<a id="__codelineno-21-30" name="__codelineno-21-30"></a>
<a id="__codelineno-21-31" name="__codelineno-21-31"></a><span class="w">    </span><span class="c1">// constructeurs</span>
<a id="__codelineno-21-32" name="__codelineno-21-32"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">UserRole</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-33" name="__codelineno-21-33"></a>
<a id="__codelineno-21-34" name="__codelineno-21-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-35" name="__codelineno-21-35"></a>
<a id="__codelineno-21-36" name="__codelineno-21-36"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">UserRole</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Role</span><span class="w"> </span><span class="n">role</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-37" name="__codelineno-21-37"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>
<a id="__codelineno-21-38" name="__codelineno-21-38"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">role</span><span class="p">;</span>
<a id="__codelineno-21-39" name="__codelineno-21-39"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-40" name="__codelineno-21-40"></a>
<a id="__codelineno-21-41" name="__codelineno-21-41"></a><span class="w">    </span><span class="c1">// getters et setters</span>
<a id="__codelineno-21-42" name="__codelineno-21-42"></a><span class="p">...</span>
<a id="__codelineno-21-43" name="__codelineno-21-43"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 22-24 : matérialisent la clé étrangère de la table [USERS_ROLES] vers la table [USERS] ;</li>
<li>lignes 27-29 : matérialisent la clé étrangère de la table [USERS_ROLES] vers la table [ROLES] ;</li>
</ul>
<h3 id="1645-les-repositories">16.4.5. Les [repositories]</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000042B000000FAD8CF0402.png" style="display:inline-block; margin:4px;width:14.116cm;height:3.307cm;" /></td></tr></table>

<p>Chacune des entités JPA précédentes est gérée par un [repository] Spring Data :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000F7000000BB6C336B6A.png" style="display:inline-block; margin:4px;width:4.57cm;height:3.461cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>L'interface [UserRepository] gère les accès aux entités [User] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span>
<span class="normal"><a href="#__codelineno-22-20">20</a></span>
<span class="normal"><a href="#__codelineno-22-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.repositories</span><span class="p">;</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.repository.Query</span><span class="p">;</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.repository.CrudRepository</span><span class="p">;</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.Role</span><span class="p">;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.User</span><span class="p">;</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">User</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">    </span><span class="c1">// liste des rôles d&#39;un utilisateur identifié par son id</span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">    </span><span class="nd">@Query</span><span class="p">(</span><span class="s">&quot;select ur.role from UserRole ur where ur.user.id=?1&quot;</span><span class="p">)</span>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">    </span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getRoles</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">    </span><span class="c1">// liste des rôles d&#39;un utilisateur identifié par son login unique</span>
<a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="w">    </span><span class="nd">@Query</span><span class="p">(</span><span class="s">&quot;select ur.role from UserRole ur where ur.user.login=?1 and ur.user.password=?2&quot;</span><span class="p">)</span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">    </span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getRoles</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">login</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">);</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">    </span><span class="c1">// recherche d&#39;un utilisateur via son login</span>
<a id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="nf">findUserByLogin</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">login</span><span class="p">);</span>
<a id="__codelineno-22-21" name="__codelineno-22-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 9 : l'interface [UserRepository] étend l'interface [CrudRepository] de Spring Data (ligne 4) ;</li>
<li>lignes 12-13 : la méthode [getRoles(User user)] permet d'avoir tous les rôles d'un utilisateur identifié par son [id]</li>
<li>lignes 16-17 : idem mais pour un utilisateur identifié pas ses login / mot de passe ;</li>
<li>ligne 20 : pour trouver un utilisateur via son login ;
L'interface [RoleRepository] gère les accès aux entités [Role] :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.repositories</span><span class="p">;</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.repository.CrudRepository</span><span class="p">;</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.Role</span><span class="p">;</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">RoleRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">Role</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">    </span><span class="c1">// recherche d&#39;un rôle via son nom</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">    </span><span class="n">Role</span><span class="w"> </span><span class="nf">findRoleByName</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 7 : l'interface [RoleRepository] étend l'interface [CrudRepository] ;</li>
<li>ligne 10 : on peut chercher un rôle via son nom ;
L'interface [UserRoleRepository] gère les accès aux entités [UserRole] :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span>
<span class="normal"><a href="#__codelineno-24-3">3</a></span>
<span class="normal"><a href="#__codelineno-24-4">4</a></span>
<span class="normal"><a href="#__codelineno-24-5">5</a></span>
<span class="normal"><a href="#__codelineno-24-6">6</a></span>
<span class="normal"><a href="#__codelineno-24-7">7</a></span>
<span class="normal"><a href="#__codelineno-24-8">8</a></span>
<span class="normal"><a href="#__codelineno-24-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.repositories</span><span class="p">;</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.repository.CrudRepository</span><span class="p">;</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.UserRole</span><span class="p">;</span>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserRoleRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">UserRole</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 5 : l'interface [UserRoleRepository] se contente d'étendre l'interface [CrudRepository] sans lui ajouter de nouvelles méthodes ;</li>
</ul>
<h3 id="1646-les-classes-de-gestion-des-utilisateurs-et-des-roles">16.4.6. Les classes de gestion des utilisateurs et des rôles</h3>
<p>Couche[repositories]Pilote[<strong>JDBC</strong>]Couche[<strong>JPA</strong>]Couche[<strong>DAO</strong>]<strong>7</strong>Spring 4SGBD</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000F8000000B04E5DAD91.png" style="display:inline-block; margin:4px;width:4.59cm;height:3.26cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Spring Security impose la création d'une classe implémentant l'interface [UsersDetail] suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000028A000001A12033E12F.png" style="display:inline-block; margin:4px;width:11.414cm;height:7.322cm;" /></td></tr></table>

<p>Cette interface est ici implémentée par la classe [AppUserDetails] :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span>
<span class="normal"><a href="#__codelineno-25-21">21</a></span>
<span class="normal"><a href="#__codelineno-25-22">22</a></span>
<span class="normal"><a href="#__codelineno-25-23">23</a></span>
<span class="normal"><a href="#__codelineno-25-24">24</a></span>
<span class="normal"><a href="#__codelineno-25-25">25</a></span>
<span class="normal"><a href="#__codelineno-25-26">26</a></span>
<span class="normal"><a href="#__codelineno-25-27">27</a></span>
<span class="normal"><a href="#__codelineno-25-28">28</a></span>
<span class="normal"><a href="#__codelineno-25-29">29</a></span>
<span class="normal"><a href="#__codelineno-25-30">30</a></span>
<span class="normal"><a href="#__codelineno-25-31">31</a></span>
<span class="normal"><a href="#__codelineno-25-32">32</a></span>
<span class="normal"><a href="#__codelineno-25-33">33</a></span>
<span class="normal"><a href="#__codelineno-25-34">34</a></span>
<span class="normal"><a href="#__codelineno-25-35">35</a></span>
<span class="normal"><a href="#__codelineno-25-36">36</a></span>
<span class="normal"><a href="#__codelineno-25-37">37</a></span>
<span class="normal"><a href="#__codelineno-25-38">38</a></span>
<span class="normal"><a href="#__codelineno-25-39">39</a></span>
<span class="normal"><a href="#__codelineno-25-40">40</a></span>
<span class="normal"><a href="#__codelineno-25-41">41</a></span>
<span class="normal"><a href="#__codelineno-25-42">42</a></span>
<span class="normal"><a href="#__codelineno-25-43">43</a></span>
<span class="normal"><a href="#__codelineno-25-44">44</a></span>
<span class="normal"><a href="#__codelineno-25-45">45</a></span>
<span class="normal"><a href="#__codelineno-25-46">46</a></span>
<span class="normal"><a href="#__codelineno-25-47">47</a></span>
<span class="normal"><a href="#__codelineno-25-48">48</a></span>
<span class="normal"><a href="#__codelineno-25-49">49</a></span>
<span class="normal"><a href="#__codelineno-25-50">50</a></span>
<span class="normal"><a href="#__codelineno-25-51">51</a></span>
<span class="normal"><a href="#__codelineno-25-52">52</a></span>
<span class="normal"><a href="#__codelineno-25-53">53</a></span>
<span class="normal"><a href="#__codelineno-25-54">54</a></span>
<span class="normal"><a href="#__codelineno-25-55">55</a></span>
<span class="normal"><a href="#__codelineno-25-56">56</a></span>
<span class="normal"><a href="#__codelineno-25-57">57</a></span>
<span class="normal"><a href="#__codelineno-25-58">58</a></span>
<span class="normal"><a href="#__codelineno-25-59">59</a></span>
<span class="normal"><a href="#__codelineno-25-60">60</a></span>
<span class="normal"><a href="#__codelineno-25-61">61</a></span>
<span class="normal"><a href="#__codelineno-25-62">62</a></span>
<span class="normal"><a href="#__codelineno-25-63">63</a></span>
<span class="normal"><a href="#__codelineno-25-64">64</a></span>
<span class="normal"><a href="#__codelineno-25-65">65</a></span>
<span class="normal"><a href="#__codelineno-25-66">66</a></span>
<span class="normal"><a href="#__codelineno-25-67">67</a></span>
<span class="normal"><a href="#__codelineno-25-68">68</a></span>
<span class="normal"><a href="#__codelineno-25-69">69</a></span>
<span class="normal"><a href="#__codelineno-25-70">70</a></span>
<span class="normal"><a href="#__codelineno-25-71">71</a></span>
<span class="normal"><a href="#__codelineno-25-72">72</a></span>
<span class="normal"><a href="#__codelineno-25-73">73</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.dao</span><span class="p">;</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.GrantedAuthority</span><span class="p">;</span>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.authority.SimpleGrantedAuthority</span><span class="p">;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="p">;</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.Role</span><span class="p">;</span>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.User</span><span class="p">;</span>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.repositories.UserRepository</span><span class="p">;</span>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AppUserDetails</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserDetails</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a>
<a id="__codelineno-25-16" name="__codelineno-25-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">serialVersionUID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1L</span><span class="p">;</span>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a>
<a id="__codelineno-25-18" name="__codelineno-25-18"></a><span class="w">    </span><span class="c1">// propriétés</span>
<a id="__codelineno-25-19" name="__codelineno-25-19"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>
<a id="__codelineno-25-20" name="__codelineno-25-20"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UserRepository</span><span class="w"> </span><span class="n">userRepository</span><span class="p">;</span>
<a id="__codelineno-25-21" name="__codelineno-25-21"></a>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a><span class="w">    </span><span class="c1">// constructeurs</span>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">AppUserDetails</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-24" name="__codelineno-25-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-25" name="__codelineno-25-25"></a>
<a id="__codelineno-25-26" name="__codelineno-25-26"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">AppUserDetails</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">UserRepository</span><span class="w"> </span><span class="n">userRepository</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-27" name="__codelineno-25-27"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>
<a id="__codelineno-25-28" name="__codelineno-25-28"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">userRepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">;</span>
<a id="__codelineno-25-29" name="__codelineno-25-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-30" name="__codelineno-25-30"></a>
<a id="__codelineno-25-31" name="__codelineno-25-31"></a><span class="w">    </span><span class="c1">// -------------------------interface</span>
<a id="__codelineno-25-32" name="__codelineno-25-32"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-25-33" name="__codelineno-25-33"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Collection</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAuthorities</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-34" name="__codelineno-25-34"></a><span class="w">        </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">GrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-25-35" name="__codelineno-25-35"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Role</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">getRoles</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-36" name="__codelineno-25-36"></a><span class="w">            </span><span class="n">authorities</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SimpleGrantedAuthority</span><span class="p">(</span><span class="n">role</span><span class="p">.</span><span class="na">getName</span><span class="p">()));</span>
<a id="__codelineno-25-37" name="__codelineno-25-37"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-25-38" name="__codelineno-25-38"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">authorities</span><span class="p">;</span>
<a id="__codelineno-25-39" name="__codelineno-25-39"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-40" name="__codelineno-25-40"></a>
<a id="__codelineno-25-41" name="__codelineno-25-41"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-25-42" name="__codelineno-25-42"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getPassword</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-43" name="__codelineno-25-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getPassword</span><span class="p">();</span>
<a id="__codelineno-25-44" name="__codelineno-25-44"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-45" name="__codelineno-25-45"></a>
<a id="__codelineno-25-46" name="__codelineno-25-46"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-25-47" name="__codelineno-25-47"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getUsername</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-48" name="__codelineno-25-48"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getLogin</span><span class="p">();</span>
<a id="__codelineno-25-49" name="__codelineno-25-49"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-50" name="__codelineno-25-50"></a>
<a id="__codelineno-25-51" name="__codelineno-25-51"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-25-52" name="__codelineno-25-52"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAccountNonExpired</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-53" name="__codelineno-25-53"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-25-54" name="__codelineno-25-54"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-55" name="__codelineno-25-55"></a>
<a id="__codelineno-25-56" name="__codelineno-25-56"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-25-57" name="__codelineno-25-57"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAccountNonLocked</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-58" name="__codelineno-25-58"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-25-59" name="__codelineno-25-59"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-60" name="__codelineno-25-60"></a>
<a id="__codelineno-25-61" name="__codelineno-25-61"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-25-62" name="__codelineno-25-62"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCredentialsNonExpired</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-63" name="__codelineno-25-63"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-25-64" name="__codelineno-25-64"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-65" name="__codelineno-25-65"></a>
<a id="__codelineno-25-66" name="__codelineno-25-66"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-25-67" name="__codelineno-25-67"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isEnabled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-68" name="__codelineno-25-68"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-25-69" name="__codelineno-25-69"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-70" name="__codelineno-25-70"></a>
<a id="__codelineno-25-71" name="__codelineno-25-71"></a><span class="w">    </span><span class="c1">// getters et setters</span>
<a id="__codelineno-25-72" name="__codelineno-25-72"></a><span class="w">    </span><span class="p">...</span>
<a id="__codelineno-25-73" name="__codelineno-25-73"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 14 : la classe [AppUserDetails] implémente l'interface [UserDetails] ;</li>
<li>lignes 19-20 : la classe encapsule un utilisateur (ligne 19) et le repository qui permet d'avoir les détails de cet utilisateur (ligne 20) ;</li>
<li>lignes 26-29 : le constructeur qui instancie la classe avec un utilisateur et son repository ;</li>
<li>lignes 32-36 : implémentation de la méthode [getAuthorities] de l'interface [UserDetails]. Elle doit construire une collection d'éléments de type [GrantedAuthority] ou dérivé. Ici, nous utilisons le type dérivé [SimpleGrantedAuthority] (ligne 36) qui encapsule le nom d'un des rôles de l'utilisateur de la ligne 19 ;</li>
<li>lignes 35-37 : on parcourt la liste des rôles de l'utilisateur de la ligne 19 pour construire une liste d'éléments de type [SimpleGrantedAuthority] ;</li>
<li>lignes 42-44 : implémentent la méthode [getPassword] de l'interface [UserDetails]. On rend le mot de passe  de l'utilisateur de la ligne 19 ;</li>
<li>lignes 42-44 : implémentent la méthode [getUserName] de l'interface [UserDetails]. On rend le login  de l'utilisateur de la ligne 19 ;</li>
<li>lignes 51-54 : le compte de l'utilisateur n'expire jamais ;</li>
<li>lignes 56-59 : le compte de l'utilisateur n'est jamais bloqué ;</li>
<li>lignes 61-64 : les identifiants de l'utilisateur n'expirent jamais ;</li>
<li>lignes 66-69 :  le compte de l'utilisateur est toujours actif ;
Spring Security impose également l'existence d'une classe implémentant l'interface [AppUserDetailsService] :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000019C0000007FEE7FC945.png" style="display:inline-block; margin:4px;width:7.631cm;height:2.35cm;" /></td></tr></table>

<p>Cette interface est implémentée par la classe [AppUserDetailsService] suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span>
<span class="normal"><a href="#__codelineno-26-18">18</a></span>
<span class="normal"><a href="#__codelineno-26-19">19</a></span>
<span class="normal"><a href="#__codelineno-26-20">20</a></span>
<span class="normal"><a href="#__codelineno-26-21">21</a></span>
<span class="normal"><a href="#__codelineno-26-22">22</a></span>
<span class="normal"><a href="#__codelineno-26-23">23</a></span>
<span class="normal"><a href="#__codelineno-26-24">24</a></span>
<span class="normal"><a href="#__codelineno-26-25">25</a></span>
<span class="normal"><a href="#__codelineno-26-26">26</a></span>
<span class="normal"><a href="#__codelineno-26-27">27</a></span>
<span class="normal"><a href="#__codelineno-26-28">28</a></span>
<span class="normal"><a href="#__codelineno-26-29">29</a></span>
<span class="normal"><a href="#__codelineno-26-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.dao</span><span class="p">;</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.userdetails.UserDetails</span><span class="p">;</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.userdetails.UserDetailsService</span><span class="p">;</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.userdetails.UsernameNotFoundException</span><span class="p">;</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Service</span><span class="p">;</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.User</span><span class="p">;</span>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.repositories.UserRepository</span><span class="p">;</span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="nd">@Service</span>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AppUserDetailsService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserDetailsService</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UserRepository</span><span class="w"> </span><span class="n">userRepository</span><span class="p">;</span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a>
<a id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-26-19" name="__codelineno-26-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserDetails</span><span class="w"> </span><span class="nf">loadUserByUsername</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">login</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">UsernameNotFoundException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="w">        </span><span class="c1">// on cherche l&#39;utilisateur via son login</span>
<a id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findUserByLogin</span><span class="p">(</span><span class="n">login</span><span class="p">);</span>
<a id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="w">        </span><span class="c1">// trouvé ?</span>
<a id="__codelineno-26-23" name="__codelineno-26-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsernameNotFoundException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;login [%s] inexistant&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">login</span><span class="p">));</span>
<a id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-26" name="__codelineno-26-26"></a><span class="w">        </span><span class="c1">// on rend les détails de l&#39;utilsateur</span>
<a id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppUserDetails</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">userRepository</span><span class="p">);</span>
<a id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-29" name="__codelineno-26-29"></a>
<a id="__codelineno-26-30" name="__codelineno-26-30"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 12 : la classe sera un composant Spring, donc disponible dans son contexte ;</li>
<li>lignes 15-16 : le composant [UserRepository] sera injecté ici ;</li>
<li>lignes 19-28 : implémentation de la méthode [loadUserByUsername] de l'interface [UserDetailsService] (ligne 10). Le paramètre est le login de l'utilisateur ;</li>
<li>ligne 21 : l'utilisateur est recherché via son login ;</li>
<li>lignes 23-25 : s'il n'est pas trouvé, une exception est lancée ;</li>
<li>ligne 27 : un objet [AppUserDetails] est construit et rendu. Il est bien de type [UserDetails] (ligne 19) ;</li>
</ul>
<h3 id="1647-la-configuration-du-projet">16.4.7. La configuration du projet</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000055A00000159EA15AF59.png" style="display:inline-block; margin:4px;width:17.999cm;height:4.533cm;" /></td></tr></table>

<p>Le projet est configuré par deux classes :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><p style="margin:0;"><b>1</b></p><img src="images/1000000000000100000000CE88ADF4FE.png" style="display:inline-block; margin:4px;width:4.74cm;height:3.821cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>La classe [DaoConfig] configure la couche [DAO] amenée par le nouveau projet :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.config</span><span class="p">;</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.ComponentScan</span><span class="p">;</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Import</span><span class="p">;</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.data.jpa.repository.config.EnableJpaRepositories</span><span class="p">;</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="nd">@EnableJpaRepositories</span><span class="p">(</span><span class="n">basePackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;spring.security.repositories&quot;</span><span class="w"> </span><span class="p">})</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="nd">@ComponentScan</span><span class="p">(</span><span class="n">basePackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;spring.security.dao&quot;</span><span class="w"> </span><span class="p">})</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="nd">@Import</span><span class="p">({</span><span class="w"> </span><span class="n">spring</span><span class="p">.</span><span class="na">data</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">DaoConfig</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">})</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DaoConfig</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a>
<a id="__codelineno-27-13" name="__codelineno-27-13"></a><span class="w">    </span><span class="c1">// constantes</span>
<a id="__codelineno-27-14" name="__codelineno-27-14"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">ENTITIES_PACKAGES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;spring.data.entities&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;spring.security.entities&quot;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-27-15" name="__codelineno-27-15"></a>
<a id="__codelineno-27-16" name="__codelineno-27-16"></a><span class="w">    </span><span class="nd">@Bean</span>
<a id="__codelineno-27-17" name="__codelineno-27-17"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="nf">packagesToScan</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-18" name="__codelineno-27-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ENTITIES_PACKAGES</span><span class="p">;</span>
<a id="__codelineno-27-19" name="__codelineno-27-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-27-20" name="__codelineno-27-20"></a>
<a id="__codelineno-27-21" name="__codelineno-27-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 10 : on importe la classe de configuration [spring.data.config.DaoConfig] du projet [intro-spring-data-01] qui implémente la couche [DAO] des produits et catégories ;</li>
<li>ligne 8 : on désigne les dossiers du projet courant contenant des [repositories] Spring Data ;</li>
<li>ligne 9 : on désigne les dossiers du projet courant contenant des composants Spring concernant la couche [DAO] ;</li>
<li>ligne 14 : on désigne les dossiers contenant des entités JPA. Il y a celles du projet [intro-spring-data-01] et celles du projet du serveur sécurisé. Cette information fait l'objet du bean des lignes 16-19. Ce bean redéfinit le bean de même nom du projet [intro-spring-data-01] :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span>
<span class="normal"><a href="#__codelineno-28-12">12</a></span>
<span class="normal"><a href="#__codelineno-28-13">13</a></span>
<span class="normal"><a href="#__codelineno-28-14">14</a></span>
<span class="normal"><a href="#__codelineno-28-15">15</a></span>
<span class="normal"><a href="#__codelineno-28-16">16</a></span>
<span class="normal"><a href="#__codelineno-28-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">ENTITIES_PACKAGES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;spring.data.entities&quot;</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="c1">// EntityManagerFactory</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span><span class="nd">@Bean</span>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">EntityManagerFactory</span><span class="w"> </span><span class="nf">entityManagerFactory</span><span class="p">(</span><span class="n">JpaVendorAdapter</span><span class="w"> </span><span class="n">jpaVendorAdapter</span><span class="p">,</span><span class="w"> </span><span class="n">DataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">        </span><span class="n">LocalContainerEntityManagerFactoryBean</span><span class="w"> </span><span class="n">factory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LocalContainerEntityManagerFactoryBean</span><span class="p">();</span>
<a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">        </span><span class="n">factory</span><span class="p">.</span><span class="na">setJpaVendorAdapter</span><span class="p">(</span><span class="n">jpaVendorAdapter</span><span class="p">);</span>
<a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">        </span><span class="n">factory</span><span class="p">.</span><span class="na">setPackagesToScan</span><span class="p">(</span><span class="n">packagesToScan</span><span class="p">());</span>
<a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="w">        </span><span class="n">factory</span><span class="p">.</span><span class="na">setDataSource</span><span class="p">(</span><span class="n">dataSource</span><span class="p">);</span>
<a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="w">        </span><span class="n">factory</span><span class="p">.</span><span class="na">afterPropertiesSet</span><span class="p">();</span>
<a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="na">getObject</span><span class="p">();</span>
<a id="__codelineno-28-12" name="__codelineno-28-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-28-13" name="__codelineno-28-13"></a>
<a id="__codelineno-28-14" name="__codelineno-28-14"></a><span class="w">    </span><span class="nd">@Bean</span>
<a id="__codelineno-28-15" name="__codelineno-28-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="nf">packagesToScan</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-16" name="__codelineno-28-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ENTITIES_PACKAGES</span><span class="p">;</span>
<a id="__codelineno-28-17" name="__codelineno-28-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></li>
</ul>
<p>Dans la couche [DAO], la ligne 8 scanne les dossiers indiqués ligne 1. A cause de la redéfinition du bean des lignes 14-17 dans le projet sécurisé (lignes 16-19), la ligne 8 ci-dessus va désormais scanner les dossiers ["spring.data.entities", "spring.security.entities"]. Il est à noter que la classe importée ligne 10 de la classe [spring.security.config.DaoConfig] doit comporter l'annotation [@Configuration], sinon le phénomène qui vient d'être expliqué ne fonctionne pas.</p>
<p>La classe [SecurityConfig] configure l'aspect sécurité du projet. Nous avons déjà rencontré une classe de configuration de Spring Security :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span>
<span class="normal"><a href="#__codelineno-29-16">16</a></span>
<span class="normal"><a href="#__codelineno-29-17">17</a></span>
<span class="normal"><a href="#__codelineno-29-18">18</a></span>
<span class="normal"><a href="#__codelineno-29-19">19</a></span>
<span class="normal"><a href="#__codelineno-29-20">20</a></span>
<span class="normal"><a href="#__codelineno-29-21">21</a></span>
<span class="normal"><a href="#__codelineno-29-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">hello</span><span class="p">;</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Configuration</span><span class="p">;</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="p">;</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="p">;</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="p">;</span>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.servlet.configuration.EnableWebMvcSecurity</span><span class="p">;</span>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a>
<a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="nd">@Configuration</span>
<a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="nd">@EnableWebMvcSecurity</span>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WebSecurityConfig</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">WebSecurityConfigurerAdapter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">().</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/home&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">().</span><span class="na">anyRequest</span><span class="p">().</span><span class="na">authenticated</span><span class="p">();</span>
<a id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">formLogin</span><span class="p">().</span><span class="na">loginPage</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">().</span><span class="na">and</span><span class="p">().</span><span class="na">logout</span><span class="p">().</span><span class="na">permitAll</span><span class="p">();</span>
<a id="__codelineno-29-16" name="__codelineno-29-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-17" name="__codelineno-29-17"></a>
<a id="__codelineno-29-18" name="__codelineno-29-18"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-29-19" name="__codelineno-29-19"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">AuthenticationManagerBuilder</span><span class="w"> </span><span class="n">auth</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-20" name="__codelineno-29-20"></a><span class="w">        </span><span class="n">auth</span><span class="p">.</span><span class="na">inMemoryAuthentication</span><span class="p">().</span><span class="na">withUser</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">).</span><span class="na">password</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">).</span><span class="na">roles</span><span class="p">(</span><span class="s">&quot;USER&quot;</span><span class="p">);</span>
<a id="__codelineno-29-21" name="__codelineno-29-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-22" name="__codelineno-29-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Nous allons suivre la même démarche :</p>
<ul>
<li>ligne 11 : définir une classe qui étend la classe [WebSecurityConfigurerAdapter] ;</li>
<li>ligne 13 : définir une méthode [configure(HttpSecurity http)] qui définit les droits d'accès aux différentes URL du service web ;</li>
<li>ligne 19 : définir une méthode [configure(AuthenticationManagerBuilder auth)] qui définit les utilisateurs et leurs rôles ;
La classe [SecurityConfig] sera la suivante :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span>
<span class="normal"><a href="#__codelineno-30-21">21</a></span>
<span class="normal"><a href="#__codelineno-30-22">22</a></span>
<span class="normal"><a href="#__codelineno-30-23">23</a></span>
<span class="normal"><a href="#__codelineno-30-24">24</a></span>
<span class="normal"><a href="#__codelineno-30-25">25</a></span>
<span class="normal"><a href="#__codelineno-30-26">26</a></span>
<span class="normal"><a href="#__codelineno-30-27">27</a></span>
<span class="normal"><a href="#__codelineno-30-28">28</a></span>
<span class="normal"><a href="#__codelineno-30-29">29</a></span>
<span class="normal"><a href="#__codelineno-30-30">30</a></span>
<span class="normal"><a href="#__codelineno-30-31">31</a></span>
<span class="normal"><a href="#__codelineno-30-32">32</a></span>
<span class="normal"><a href="#__codelineno-30-33">33</a></span>
<span class="normal"><a href="#__codelineno-30-34">34</a></span>
<span class="normal"><a href="#__codelineno-30-35">35</a></span>
<span class="normal"><a href="#__codelineno-30-36">36</a></span>
<span class="normal"><a href="#__codelineno-30-37">37</a></span>
<span class="normal"><a href="#__codelineno-30-38">38</a></span>
<span class="normal"><a href="#__codelineno-30-39">39</a></span>
<span class="normal"><a href="#__codelineno-30-40">40</a></span>
<span class="normal"><a href="#__codelineno-30-41">41</a></span>
<span class="normal"><a href="#__codelineno-30-42">42</a></span>
<span class="normal"><a href="#__codelineno-30-43">43</a></span>
<span class="normal"><a href="#__codelineno-30-44">44</a></span>
<span class="normal"><a href="#__codelineno-30-45">45</a></span>
<span class="normal"><a href="#__codelineno-30-46">46</a></span>
<span class="normal"><a href="#__codelineno-30-47">47</a></span>
<span class="normal"><a href="#__codelineno-30-48">48</a></span>
<span class="normal"><a href="#__codelineno-30-49">49</a></span>
<span class="normal"><a href="#__codelineno-30-50">50</a></span>
<span class="normal"><a href="#__codelineno-30-51">51</a></span>
<span class="normal"><a href="#__codelineno-30-52">52</a></span>
<span class="normal"><a href="#__codelineno-30-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.config</span><span class="p">;</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.ComponentScan</span><span class="p">;</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Import</span><span class="p">;</span>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.HttpMethod</span><span class="p">;</span>
<a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder</span><span class="p">;</span>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.builders.HttpSecurity</span><span class="p">;</span>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.configuration.EnableWebSecurity</span><span class="p">;</span>
<a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</span><span class="p">;</span>
<a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.config.http.SessionCreationPolicy</span><span class="p">;</span>
<a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder</span><span class="p">;</span>
<a id="__codelineno-30-13" name="__codelineno-30-13"></a>
<a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.dao.AppUserDetailsService</span><span class="p">;</span>
<a id="__codelineno-30-15" name="__codelineno-30-15"></a>
<a id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="nd">@EnableWebSecurity</span>
<a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="nd">@ComponentScan</span><span class="p">(</span><span class="n">basePackages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;spring.security.service&quot;</span><span class="w"> </span><span class="p">})</span>
<a id="__codelineno-30-18" name="__codelineno-30-18"></a><span class="nd">@Import</span><span class="p">({</span><span class="w"> </span><span class="n">spring</span><span class="p">.</span><span class="na">webjson</span><span class="p">.</span><span class="na">config</span><span class="p">.</span><span class="na">AppConfig</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">DaoConfig</span><span class="p">.</span><span class="na">class</span><span class="w"> </span><span class="p">})</span>
<a id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecurityConfig</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">WebSecurityConfigurerAdapter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-20" name="__codelineno-30-20"></a>
<a id="__codelineno-30-21" name="__codelineno-30-21"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-30-22" name="__codelineno-30-22"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">AppUserDetailsService</span><span class="w"> </span><span class="n">appUserDetailsService</span><span class="p">;</span>
<a id="__codelineno-30-23" name="__codelineno-30-23"></a>
<a id="__codelineno-30-24" name="__codelineno-30-24"></a><span class="w">    </span><span class="c1">// sécurisation</span>
<a id="__codelineno-30-25" name="__codelineno-30-25"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">activateSecurity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-30-26" name="__codelineno-30-26"></a>
<a id="__codelineno-30-27" name="__codelineno-30-27"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-30-28" name="__codelineno-30-28"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">AuthenticationManagerBuilder</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-29" name="__codelineno-30-29"></a><span class="w">        </span><span class="c1">// l&#39;authentification est faite par le bean [appUserDetailsService]</span>
<a id="__codelineno-30-30" name="__codelineno-30-30"></a><span class="w">        </span><span class="c1">// le mot de passe est crypté par l&#39;algorithme de hachage BCrypt</span>
<a id="__codelineno-30-31" name="__codelineno-30-31"></a><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">userDetailsService</span><span class="p">(</span><span class="n">appUserDetailsService</span><span class="p">).</span><span class="na">passwordEncoder</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">BCryptPasswordEncoder</span><span class="p">());</span>
<a id="__codelineno-30-32" name="__codelineno-30-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-33" name="__codelineno-30-33"></a>
<a id="__codelineno-30-34" name="__codelineno-30-34"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-30-35" name="__codelineno-30-35"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-36" name="__codelineno-30-36"></a><span class="w">        </span><span class="c1">// CSRF</span>
<a id="__codelineno-30-37" name="__codelineno-30-37"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">csrf</span><span class="p">().</span><span class="na">disable</span><span class="p">();</span>
<a id="__codelineno-30-38" name="__codelineno-30-38"></a><span class="w">        </span><span class="c1">// application sécurisée ?</span>
<a id="__codelineno-30-39" name="__codelineno-30-39"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activateSecurity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-40" name="__codelineno-30-40"></a><span class="w">            </span><span class="c1">// le mot de passe est transmis par le header Authorization: Basic xxxx</span>
<a id="__codelineno-30-41" name="__codelineno-30-41"></a><span class="w">            </span><span class="n">http</span><span class="p">.</span><span class="na">httpBasic</span><span class="p">();</span>
<a id="__codelineno-30-42" name="__codelineno-30-42"></a><span class="w">            </span><span class="c1">// la méthode HTTP OPTIONS doit être autorisée pour tous</span>
<a id="__codelineno-30-43" name="__codelineno-30-43"></a><span class="w">            </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span><span class="w"> </span><span class="c1">//</span>
<a id="__codelineno-30-44" name="__codelineno-30-44"></a><span class="w">                    </span><span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">OPTIONS</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/**&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">();</span>
<a id="__codelineno-30-45" name="__codelineno-30-45"></a><span class="w">            </span><span class="c1">// seul le rôle ADMIN peut utiliser l&#39;application</span>
<a id="__codelineno-30-46" name="__codelineno-30-46"></a><span class="w">            </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span><span class="w"> </span><span class="c1">//</span>
<a id="__codelineno-30-47" name="__codelineno-30-47"></a><span class="w">                    </span><span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/**&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// toutes les URL</span>
<a id="__codelineno-30-48" name="__codelineno-30-48"></a><span class="w">                    </span><span class="p">.</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;ADMIN&quot;</span><span class="p">);</span>
<a id="__codelineno-30-49" name="__codelineno-30-49"></a><span class="w">            </span><span class="c1">// pas de session</span>
<a id="__codelineno-30-50" name="__codelineno-30-50"></a><span class="w">            </span><span class="n">http</span><span class="p">.</span><span class="na">sessionManagement</span><span class="p">().</span><span class="na">sessionCreationPolicy</span><span class="p">(</span><span class="n">SessionCreationPolicy</span><span class="p">.</span><span class="na">STATELESS</span><span class="p">);</span>
<a id="__codelineno-30-51" name="__codelineno-30-51"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-30-52" name="__codelineno-30-52"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-53" name="__codelineno-30-53"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 16 : pour activer les éléments de Spring Security ;</li>
<li>ligne 17 : on rajoute les composants Spring du package [spring.security.service] ;</li>
<li>ligne 18 : on importe les beans de la couche [DAO] que l'on vient de présenter ainsi que ceux du serveur web / jSON non sécurisé ;</li>
<li>lignes 21-22 : la classe [AppUserDetails] qui donne accès aux utilisateurs de l'application est injectée ;</li>
<li>ligne 25 : un booléen qui sécurise (true) ou non (false) l'application web ;</li>
<li>lignes 27-32 : la méthode [configure(HttpSecurity http)] définit les utilisateurs et leurs rôles. Elle reçoit en paramètre un type [AuthenticationManagerBuilder]. Ce paramètre est enrichi de deux informations (ligne 38) :</li>
<li>une référence sur le service [appUserDetailsService] de la ligne 22 qui donne accès aux utilisateurs enregistrés. On notera ici que le fait qu'ils soient enregistrés dans une base de données n'apparaît pas. Ils pourraient donc être dans un cache, délivrés par un service web, ...</li>
<li>le type de cryptage utilisé pour le mot de passe. On rappelle ici que nous avons utilisé l'algorithme BCrypt ;</li>
<li>lignes 34-52 : la méthode [configure(HttpSecurity http)] définit les droits d'accès aux URL du service web ;</li>
<li>ligne 37 : nous avons vu dans le projet d'introduction que par défaut Spring Security gérait un jeton CSRF (Cross Site Request Forgery) que l'utilisateur qui voulait s'authentifier devait renvoyer au serveur. Ici ce mécanisme est désactivé. Ceci allié au booléen (isSecured=false) permet d'utiliser l'application web sans sécurité ;</li>
<li>ligne 41 : on active le mode d'authentification par entête HTTP. Le client devra envoyer l'entête HTTP suivant :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a>Authorization:Basic code
</code></pre></div></td></tr></table></div></li>
</ul>
<p>où code est le codage de la chaîne <strong>login:password</strong> par l'algorithme Base64. Par exemple, le codage Base64 de la chaîne admin:admin est YWRtaW46YWRtaW4=. Donc l'utilisateur de login [admin] et de mot de passe [admin] enverra l'entête HTTP suivant pour s'authentifier :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a>Authorization:Basic YWRtaW46YWRtaW4=
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 46-48 : indiquent que toutes les URL du service web sont accessibles aux utilisateurs ayant le rôle [ROLE_ADMIN]. Cela veut dire qu'un utilisateur n'ayant pas ce rôle ne peut accéder au service web ;</li>
<li>ligne 50 : en mode [session], un utilisateur qui s'est authentifié une fois n'a pas besoin de le faire pour ses accès suivants. Ici on désactive ce mode, aussi l'utilisateur devra-t-il s'authentifier à chaque accès ;</li>
</ul>
<h3 id="1648-tests-de-la-couche-dao">16.4.8. Tests de la couche [DAO]</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000004300000010D540F8048.png" style="display:inline-block; margin:4px;width:14.182cm;height:3.56cm;" /></td></tr></table>

<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000C800000059F3626BCE.png" style="display:inline-block; margin:4px;width:3.701cm;height:1.649cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Tout d'abord, nous créons une classe exécutable [CreateUser] capable de créer un utilisateur avec un rôle :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span>
<span class="normal"><a href="#__codelineno-33-18">18</a></span>
<span class="normal"><a href="#__codelineno-33-19">19</a></span>
<span class="normal"><a href="#__codelineno-33-20">20</a></span>
<span class="normal"><a href="#__codelineno-33-21">21</a></span>
<span class="normal"><a href="#__codelineno-33-22">22</a></span>
<span class="normal"><a href="#__codelineno-33-23">23</a></span>
<span class="normal"><a href="#__codelineno-33-24">24</a></span>
<span class="normal"><a href="#__codelineno-33-25">25</a></span>
<span class="normal"><a href="#__codelineno-33-26">26</a></span>
<span class="normal"><a href="#__codelineno-33-27">27</a></span>
<span class="normal"><a href="#__codelineno-33-28">28</a></span>
<span class="normal"><a href="#__codelineno-33-29">29</a></span>
<span class="normal"><a href="#__codelineno-33-30">30</a></span>
<span class="normal"><a href="#__codelineno-33-31">31</a></span>
<span class="normal"><a href="#__codelineno-33-32">32</a></span>
<span class="normal"><a href="#__codelineno-33-33">33</a></span>
<span class="normal"><a href="#__codelineno-33-34">34</a></span>
<span class="normal"><a href="#__codelineno-33-35">35</a></span>
<span class="normal"><a href="#__codelineno-33-36">36</a></span>
<span class="normal"><a href="#__codelineno-33-37">37</a></span>
<span class="normal"><a href="#__codelineno-33-38">38</a></span>
<span class="normal"><a href="#__codelineno-33-39">39</a></span>
<span class="normal"><a href="#__codelineno-33-40">40</a></span>
<span class="normal"><a href="#__codelineno-33-41">41</a></span>
<span class="normal"><a href="#__codelineno-33-42">42</a></span>
<span class="normal"><a href="#__codelineno-33-43">43</a></span>
<span class="normal"><a href="#__codelineno-33-44">44</a></span>
<span class="normal"><a href="#__codelineno-33-45">45</a></span>
<span class="normal"><a href="#__codelineno-33-46">46</a></span>
<span class="normal"><a href="#__codelineno-33-47">47</a></span>
<span class="normal"><a href="#__codelineno-33-48">48</a></span>
<span class="normal"><a href="#__codelineno-33-49">49</a></span>
<span class="normal"><a href="#__codelineno-33-50">50</a></span>
<span class="normal"><a href="#__codelineno-33-51">51</a></span>
<span class="normal"><a href="#__codelineno-33-52">52</a></span>
<span class="normal"><a href="#__codelineno-33-53">53</a></span>
<span class="normal"><a href="#__codelineno-33-54">54</a></span>
<span class="normal"><a href="#__codelineno-33-55">55</a></span>
<span class="normal"><a href="#__codelineno-33-56">56</a></span>
<span class="normal"><a href="#__codelineno-33-57">57</a></span>
<span class="normal"><a href="#__codelineno-33-58">58</a></span>
<span class="normal"><a href="#__codelineno-33-59">59</a></span>
<span class="normal"><a href="#__codelineno-33-60">60</a></span>
<span class="normal"><a href="#__codelineno-33-61">61</a></span>
<span class="normal"><a href="#__codelineno-33-62">62</a></span>
<span class="normal"><a href="#__codelineno-33-63">63</a></span>
<span class="normal"><a href="#__codelineno-33-64">64</a></span>
<span class="normal"><a href="#__codelineno-33-65">65</a></span>
<span class="normal"><a href="#__codelineno-33-66">66</a></span>
<span class="normal"><a href="#__codelineno-33-67">67</a></span>
<span class="normal"><a href="#__codelineno-33-68">68</a></span>
<span class="normal"><a href="#__codelineno-33-69">69</a></span>
<span class="normal"><a href="#__codelineno-33-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">sprin.security.tests</span><span class="p">;</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><span class="p">;</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.crypto.bcrypt.BCrypt</span><span class="p">;</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.config.DaoConfig</span><span class="p">;</span>
<a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.Role</span><span class="p">;</span>
<a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.User</span><span class="p">;</span>
<a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.UserRole</span><span class="p">;</span>
<a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.repositories.RoleRepository</span><span class="p">;</span>
<a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.repositories.UserRepository</span><span class="p">;</span>
<a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.repositories.UserRoleRepository</span><span class="p">;</span>
<a id="__codelineno-33-13" name="__codelineno-33-13"></a>
<a id="__codelineno-33-14" name="__codelineno-33-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CreateUser</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-15" name="__codelineno-33-15"></a>
<a id="__codelineno-33-16" name="__codelineno-33-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-17" name="__codelineno-33-17"></a><span class="w">        </span><span class="c1">// syntaxe : login password roleName</span>
<a id="__codelineno-33-18" name="__codelineno-33-18"></a>
<a id="__codelineno-33-19" name="__codelineno-33-19"></a><span class="w">        </span><span class="c1">// il faut trois paramètres</span>
<a id="__codelineno-33-20" name="__codelineno-33-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-21" name="__codelineno-33-21"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Syntaxe : [pg] user password role&quot;</span><span class="p">);</span>
<a id="__codelineno-33-22" name="__codelineno-33-22"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-33-23" name="__codelineno-33-23"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-24" name="__codelineno-33-24"></a><span class="w">        </span><span class="c1">// on récupère les paramètres</span>
<a id="__codelineno-33-25" name="__codelineno-33-25"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">;</span>
<a id="__codelineno-33-26" name="__codelineno-33-26"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">;</span>
<a id="__codelineno-33-27" name="__codelineno-33-27"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">roleName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;ROLE_%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">());</span>
<a id="__codelineno-33-28" name="__codelineno-33-28"></a><span class="w">        </span><span class="c1">// contexte Spring</span>
<a id="__codelineno-33-29" name="__codelineno-33-29"></a><span class="w">        </span><span class="n">AnnotationConfigApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AnnotationConfigApplicationContext</span><span class="p">(</span><span class="n">DaoConfig</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-33-30" name="__codelineno-33-30"></a><span class="w">        </span><span class="n">UserRepository</span><span class="w"> </span><span class="n">userRepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">UserRepository</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-33-31" name="__codelineno-33-31"></a><span class="w">        </span><span class="n">RoleRepository</span><span class="w"> </span><span class="n">roleRepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">RoleRepository</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-33-32" name="__codelineno-33-32"></a><span class="w">        </span><span class="n">UserRoleRepository</span><span class="w"> </span><span class="n">userRoleRepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">UserRoleRepository</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-33-33" name="__codelineno-33-33"></a><span class="w">        </span><span class="c1">// le rôle existe-t-il déjà ?</span>
<a id="__codelineno-33-34" name="__codelineno-33-34"></a><span class="w">        </span><span class="n">Role</span><span class="w"> </span><span class="n">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">findRoleByName</span><span class="p">(</span><span class="n">roleName</span><span class="p">);</span>
<a id="__codelineno-33-35" name="__codelineno-33-35"></a><span class="w">        </span><span class="c1">// s&#39;il n&#39;existe pas on le crée</span>
<a id="__codelineno-33-36" name="__codelineno-33-36"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-37" name="__codelineno-33-37"></a><span class="w">            </span><span class="n">role</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roleRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Role</span><span class="p">(</span><span class="n">roleName</span><span class="p">));</span>
<a id="__codelineno-33-38" name="__codelineno-33-38"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-39" name="__codelineno-33-39"></a><span class="w">        </span><span class="c1">// l&#39;utilisateur existe-t-il déjà ?</span>
<a id="__codelineno-33-40" name="__codelineno-33-40"></a><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findUserByLogin</span><span class="p">(</span><span class="n">login</span><span class="p">);</span>
<a id="__codelineno-33-41" name="__codelineno-33-41"></a><span class="w">        </span><span class="c1">// s&#39;il n&#39;existe pas on le crée</span>
<a id="__codelineno-33-42" name="__codelineno-33-42"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-43" name="__codelineno-33-43"></a><span class="w">            </span><span class="c1">// on hashe le mot de passe avec bcrypt</span>
<a id="__codelineno-33-44" name="__codelineno-33-44"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">crypt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BCrypt</span><span class="p">.</span><span class="na">hashpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">BCrypt</span><span class="p">.</span><span class="na">gensalt</span><span class="p">());</span>
<a id="__codelineno-33-45" name="__codelineno-33-45"></a><span class="w">            </span><span class="c1">// on sauvegarde l&#39;utilisateur</span>
<a id="__codelineno-33-46" name="__codelineno-33-46"></a><span class="w">            </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="n">login</span><span class="p">,</span><span class="w"> </span><span class="n">login</span><span class="p">,</span><span class="w"> </span><span class="n">crypt</span><span class="p">));</span>
<a id="__codelineno-33-47" name="__codelineno-33-47"></a><span class="w">            </span><span class="c1">// on crée la relation avec le rôle</span>
<a id="__codelineno-33-48" name="__codelineno-33-48"></a><span class="w">            </span><span class="n">userRoleRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">UserRole</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">role</span><span class="p">));</span>
<a id="__codelineno-33-49" name="__codelineno-33-49"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-50" name="__codelineno-33-50"></a><span class="w">            </span><span class="c1">// l&#39;utilisateur existe déjà- a-t-il le rôle demandé ?</span>
<a id="__codelineno-33-51" name="__codelineno-33-51"></a><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">trouvé</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-33-52" name="__codelineno-33-52"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Role</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">getRoles</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-53" name="__codelineno-33-53"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">roleName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-54" name="__codelineno-33-54"></a><span class="w">                    </span><span class="n">trouvé</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-33-55" name="__codelineno-33-55"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-33-56" name="__codelineno-33-56"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-33-57" name="__codelineno-33-57"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-33-58" name="__codelineno-33-58"></a><span class="w">            </span><span class="c1">// si pas trouvé, on crée la relation avec le rôle</span>
<a id="__codelineno-33-59" name="__codelineno-33-59"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">trouvé</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-60" name="__codelineno-33-60"></a><span class="w">                </span><span class="n">userRoleRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">UserRole</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">role</span><span class="p">));</span>
<a id="__codelineno-33-61" name="__codelineno-33-61"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-33-62" name="__codelineno-33-62"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-63" name="__codelineno-33-63"></a>
<a id="__codelineno-33-64" name="__codelineno-33-64"></a><span class="w">        </span><span class="c1">// fermeture contexte Spring</span>
<a id="__codelineno-33-65" name="__codelineno-33-65"></a><span class="w">        </span><span class="n">context</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<a id="__codelineno-33-66" name="__codelineno-33-66"></a><span class="w">        </span><span class="c1">// fin</span>
<a id="__codelineno-33-67" name="__codelineno-33-67"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Travail terminé...&quot;</span><span class="p">);</span>
<a id="__codelineno-33-68" name="__codelineno-33-68"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-33-69" name="__codelineno-33-69"></a>
<a id="__codelineno-33-70" name="__codelineno-33-70"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 17 : la classe attend trois arguments définissant un utilisateur : son login, son mot de passe, son rôle ;</li>
<li>lignes 25-27 : les trois paramètres sont récupérés ;</li>
<li>ligne 29 : le contexte Spring est construit à partir de la classe de configuration [AppConfig] ;</li>
<li>lignes 30-32 : on récupère les références des trois [Repository] qui peuvent nous être utiles pour créer l'utilisateur ;</li>
<li>ligne 34 : on regarde si le rôle existe déjà ;</li>
<li>lignes 36-38 : si ce n'est pas le cas, on le crée en base. Il aura un nom du type [ROLE_XX] ;</li>
<li>ligne 40 : on regarde si le login existe déjà ;</li>
<li>lignes 42-49 : si le login n'existe pas, on le crée en base ;</li>
<li>
<p>ligne 44 : on crypte le mot de passe. On utilise ici, la classe [BCrypt] de Spring Security (ligne 4). On a donc besoin des archives de ce framework. Le fichier [pom.xml] inclut cette dépendance :
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span>
<span class="normal"><a href="#__codelineno-34-2">2</a></span>
<span class="normal"><a href="#__codelineno-34-3">3</a></span>
<span class="normal"><a href="#__codelineno-34-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a>        &lt;dependency&gt;
<a id="__codelineno-34-2" name="__codelineno-34-2"></a>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
<a id="__codelineno-34-3" name="__codelineno-34-3"></a>            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
<a id="__codelineno-34-4" name="__codelineno-34-4"></a>&lt;/dependency&gt;
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p>ligne 46 : l'utilisateur est persisté en base ;</p>
</li>
<li>ligne 48 : ainsi que la relation qui le lie à son rôle ;</li>
<li>lignes 51-57 : cas où le login existe déjà – on regarde alors si parmi ses rôles se trouve déjà le rôle qu'on veut lui attribuer ;</li>
<li>ligne 59-61 : si le rôle cherché n'a pas été trouvé, on crée une ligne dans la table [USERS_ROLES] pour relier l'utilisateur à son rôle ;</li>
<li>on ne s'est pas protégé des exceptions éventuelles. C'est une classe de soutien pour créer rapidement un utilisateur avec un rôle.
Lorsqu'on exécute la classe avec les arguments [x x guest], on obtient en base les résultats suivants :</li>
</ul>
<p><strong>Table [USERS]</strong></p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000025F000000704AB541BB.png" style="display:inline-block; margin:4px;width:11.24cm;height:2.071cm;" /></td></tr></table>

<p><strong>Table [ROLES]</strong></p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000BD000000701234D8E4.png" style="display:inline-block; margin:4px;width:3.5cm;height:2.071cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p><strong>Table [USERS_ROLES]</strong></p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000E10000007320F58A19.png" style="display:inline-block; margin:4px;width:4.17cm;height:2.131cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Considérons maintenant la seconde classe [UsersTest] qui est un test JUnit :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000C800000059F3626BCE.png" style="display:inline-block; margin:4px;width:3.701cm;height:1.649cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span>
<span class="normal"><a href="#__codelineno-35-14">14</a></span>
<span class="normal"><a href="#__codelineno-35-15">15</a></span>
<span class="normal"><a href="#__codelineno-35-16">16</a></span>
<span class="normal"><a href="#__codelineno-35-17">17</a></span>
<span class="normal"><a href="#__codelineno-35-18">18</a></span>
<span class="normal"><a href="#__codelineno-35-19">19</a></span>
<span class="normal"><a href="#__codelineno-35-20">20</a></span>
<span class="normal"><a href="#__codelineno-35-21">21</a></span>
<span class="normal"><a href="#__codelineno-35-22">22</a></span>
<span class="normal"><a href="#__codelineno-35-23">23</a></span>
<span class="normal"><a href="#__codelineno-35-24">24</a></span>
<span class="normal"><a href="#__codelineno-35-25">25</a></span>
<span class="normal"><a href="#__codelineno-35-26">26</a></span>
<span class="normal"><a href="#__codelineno-35-27">27</a></span>
<span class="normal"><a href="#__codelineno-35-28">28</a></span>
<span class="normal"><a href="#__codelineno-35-29">29</a></span>
<span class="normal"><a href="#__codelineno-35-30">30</a></span>
<span class="normal"><a href="#__codelineno-35-31">31</a></span>
<span class="normal"><a href="#__codelineno-35-32">32</a></span>
<span class="normal"><a href="#__codelineno-35-33">33</a></span>
<span class="normal"><a href="#__codelineno-35-34">34</a></span>
<span class="normal"><a href="#__codelineno-35-35">35</a></span>
<span class="normal"><a href="#__codelineno-35-36">36</a></span>
<span class="normal"><a href="#__codelineno-35-37">37</a></span>
<span class="normal"><a href="#__codelineno-35-38">38</a></span>
<span class="normal"><a href="#__codelineno-35-39">39</a></span>
<span class="normal"><a href="#__codelineno-35-40">40</a></span>
<span class="normal"><a href="#__codelineno-35-41">41</a></span>
<span class="normal"><a href="#__codelineno-35-42">42</a></span>
<span class="normal"><a href="#__codelineno-35-43">43</a></span>
<span class="normal"><a href="#__codelineno-35-44">44</a></span>
<span class="normal"><a href="#__codelineno-35-45">45</a></span>
<span class="normal"><a href="#__codelineno-35-46">46</a></span>
<span class="normal"><a href="#__codelineno-35-47">47</a></span>
<span class="normal"><a href="#__codelineno-35-48">48</a></span>
<span class="normal"><a href="#__codelineno-35-49">49</a></span>
<span class="normal"><a href="#__codelineno-35-50">50</a></span>
<span class="normal"><a href="#__codelineno-35-51">51</a></span>
<span class="normal"><a href="#__codelineno-35-52">52</a></span>
<span class="normal"><a href="#__codelineno-35-53">53</a></span>
<span class="normal"><a href="#__codelineno-35-54">54</a></span>
<span class="normal"><a href="#__codelineno-35-55">55</a></span>
<span class="normal"><a href="#__codelineno-35-56">56</a></span>
<span class="normal"><a href="#__codelineno-35-57">57</a></span>
<span class="normal"><a href="#__codelineno-35-58">58</a></span>
<span class="normal"><a href="#__codelineno-35-59">59</a></span>
<span class="normal"><a href="#__codelineno-35-60">60</a></span>
<span class="normal"><a href="#__codelineno-35-61">61</a></span>
<span class="normal"><a href="#__codelineno-35-62">62</a></span>
<span class="normal"><a href="#__codelineno-35-63">63</a></span>
<span class="normal"><a href="#__codelineno-35-64">64</a></span>
<span class="normal"><a href="#__codelineno-35-65">65</a></span>
<span class="normal"><a href="#__codelineno-35-66">66</a></span>
<span class="normal"><a href="#__codelineno-35-67">67</a></span>
<span class="normal"><a href="#__codelineno-35-68">68</a></span>
<span class="normal"><a href="#__codelineno-35-69">69</a></span>
<span class="normal"><a href="#__codelineno-35-70">70</a></span>
<span class="normal"><a href="#__codelineno-35-71">71</a></span>
<span class="normal"><a href="#__codelineno-35-72">72</a></span>
<span class="normal"><a href="#__codelineno-35-73">73</a></span>
<span class="normal"><a href="#__codelineno-35-74">74</a></span>
<span class="normal"><a href="#__codelineno-35-75">75</a></span>
<span class="normal"><a href="#__codelineno-35-76">76</a></span>
<span class="normal"><a href="#__codelineno-35-77">77</a></span>
<span class="normal"><a href="#__codelineno-35-78">78</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.tests</span><span class="p">;</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.Assert</span><span class="p">;</span>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.Test</span><span class="p">;</span>
<a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.runner.RunWith</span><span class="p">;</span>
<a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.SpringApplicationConfiguration</span><span class="p">;</span>
<a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.core.authority.SimpleGrantedAuthority</span><span class="p">;</span>
<a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.crypto.bcrypt.BCrypt</span><span class="p">;</span>
<a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.test.context.junit4.SpringJUnit4ClassRunner</span><span class="p">;</span>
<a id="__codelineno-35-13" name="__codelineno-35-13"></a>
<a id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.core.JsonProcessingException</span><span class="p">;</span>
<a id="__codelineno-35-15" name="__codelineno-35-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="p">;</span>
<a id="__codelineno-35-16" name="__codelineno-35-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.google.common.collect.Lists</span><span class="p">;</span>
<a id="__codelineno-35-17" name="__codelineno-35-17"></a>
<a id="__codelineno-35-18" name="__codelineno-35-18"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.config.DaoConfig</span><span class="p">;</span>
<a id="__codelineno-35-19" name="__codelineno-35-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.dao.AppUserDetails</span><span class="p">;</span>
<a id="__codelineno-35-20" name="__codelineno-35-20"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.dao.AppUserDetailsService</span><span class="p">;</span>
<a id="__codelineno-35-21" name="__codelineno-35-21"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.Role</span><span class="p">;</span>
<a id="__codelineno-35-22" name="__codelineno-35-22"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.entities.User</span><span class="p">;</span>
<a id="__codelineno-35-23" name="__codelineno-35-23"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.repositories.UserRepository</span><span class="p">;</span>
<a id="__codelineno-35-24" name="__codelineno-35-24"></a>
<a id="__codelineno-35-25" name="__codelineno-35-25"></a><span class="nd">@SpringApplicationConfiguration</span><span class="p">(</span><span class="n">classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DaoConfig</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-35-26" name="__codelineno-35-26"></a><span class="nd">@RunWith</span><span class="p">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-35-27" name="__codelineno-35-27"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UsersTest</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-28" name="__codelineno-35-28"></a>
<a id="__codelineno-35-29" name="__codelineno-35-29"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-35-30" name="__codelineno-35-30"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UserRepository</span><span class="w"> </span><span class="n">userRepository</span><span class="p">;</span>
<a id="__codelineno-35-31" name="__codelineno-35-31"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-35-32" name="__codelineno-35-32"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">AppUserDetailsService</span><span class="w"> </span><span class="n">appUserDetailsService</span><span class="p">;</span>
<a id="__codelineno-35-33" name="__codelineno-35-33"></a>
<a id="__codelineno-35-34" name="__codelineno-35-34"></a><span class="w">    </span><span class="c1">// mappeur jSON</span>
<a id="__codelineno-35-35" name="__codelineno-35-35"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="p">();</span>
<a id="__codelineno-35-36" name="__codelineno-35-36"></a>
<a id="__codelineno-35-37" name="__codelineno-35-37"></a><span class="w">    </span><span class="nd">@Test</span>
<a id="__codelineno-35-38" name="__codelineno-35-38"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">findAllUsersWithTheirRoles</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-39" name="__codelineno-35-39"></a><span class="w">        </span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
<a id="__codelineno-35-40" name="__codelineno-35-40"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">users</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-41" name="__codelineno-35-41"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;\n----------Utilisateur [%s]&quot;</span><span class="p">,</span><span class="n">mapper</span><span class="p">.</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">user</span><span class="p">)));</span>
<a id="__codelineno-35-42" name="__codelineno-35-42"></a><span class="w">            </span><span class="n">display</span><span class="p">(</span><span class="s">&quot;Roles :&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">getRoles</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">()));</span>
<a id="__codelineno-35-43" name="__codelineno-35-43"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-35-44" name="__codelineno-35-44"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-35-45" name="__codelineno-35-45"></a>
<a id="__codelineno-35-46" name="__codelineno-35-46"></a><span class="w">    </span><span class="nd">@Test</span>
<a id="__codelineno-35-47" name="__codelineno-35-47"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">findUserByLogin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-48" name="__codelineno-35-48"></a><span class="w">        </span><span class="c1">// on récupère l&#39;utilisateur [admin]</span>
<a id="__codelineno-35-49" name="__codelineno-35-49"></a><span class="w">        </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findUserByLogin</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">);</span>
<a id="__codelineno-35-50" name="__codelineno-35-50"></a><span class="w">        </span><span class="c1">// on vérifie que son mot de passe est [admin]</span>
<a id="__codelineno-35-51" name="__codelineno-35-51"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">BCrypt</span><span class="p">.</span><span class="na">checkpw</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()));</span>
<a id="__codelineno-35-52" name="__codelineno-35-52"></a><span class="w">        </span><span class="c1">// on vérifie le rôle de admin / admin</span>
<a id="__codelineno-35-53" name="__codelineno-35-53"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Role</span><span class="o">&gt;</span><span class="w"> </span><span class="n">roles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Lists</span><span class="p">.</span><span class="na">newArrayList</span><span class="p">(</span><span class="n">userRepository</span><span class="p">.</span><span class="na">getRoles</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()));</span>
<a id="__codelineno-35-54" name="__codelineno-35-54"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1L</span><span class="p">,</span><span class="w"> </span><span class="n">roles</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
<a id="__codelineno-35-55" name="__codelineno-35-55"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="s">&quot;ROLE_ADMIN&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">roles</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">getName</span><span class="p">());</span>
<a id="__codelineno-35-56" name="__codelineno-35-56"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-35-57" name="__codelineno-35-57"></a>
<a id="__codelineno-35-58" name="__codelineno-35-58"></a><span class="w">    </span><span class="nd">@Test</span>
<a id="__codelineno-35-59" name="__codelineno-35-59"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">loadUserByUsername</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-60" name="__codelineno-35-60"></a><span class="w">        </span><span class="c1">// on récupère l&#39;utilisateur [admin]</span>
<a id="__codelineno-35-61" name="__codelineno-35-61"></a><span class="w">        </span><span class="n">AppUserDetails</span><span class="w"> </span><span class="n">userDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">AppUserDetails</span><span class="p">)</span><span class="w"> </span><span class="n">appUserDetailsService</span><span class="p">.</span><span class="na">loadUserByUsername</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">);</span>
<a id="__codelineno-35-62" name="__codelineno-35-62"></a><span class="w">        </span><span class="c1">// on vérifie que son mot de passe est [admin]</span>
<a id="__codelineno-35-63" name="__codelineno-35-63"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">BCrypt</span><span class="p">.</span><span class="na">checkpw</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getPassword</span><span class="p">()));</span>
<a id="__codelineno-35-64" name="__codelineno-35-64"></a><span class="w">        </span><span class="c1">// on vérifie le rôle de admin / admin</span>
<a id="__codelineno-35-65" name="__codelineno-35-65"></a><span class="w">        </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
<a id="__codelineno-35-66" name="__codelineno-35-66"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span><span class="w"> </span><span class="n">authorities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">SimpleGrantedAuthority</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">userDetails</span><span class="p">.</span><span class="na">getAuthorities</span><span class="p">();</span>
<a id="__codelineno-35-67" name="__codelineno-35-67"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">1L</span><span class="p">,</span><span class="w"> </span><span class="n">authorities</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
<a id="__codelineno-35-68" name="__codelineno-35-68"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="s">&quot;ROLE_ADMIN&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">authorities</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="na">getAuthority</span><span class="p">());</span>
<a id="__codelineno-35-69" name="__codelineno-35-69"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-35-70" name="__codelineno-35-70"></a>
<a id="__codelineno-35-71" name="__codelineno-35-71"></a><span class="w">    </span><span class="c1">// méthode utilitaire - affiche les éléments d&#39;une collection</span>
<a id="__codelineno-35-72" name="__codelineno-35-72"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">display</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Iterable</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-73" name="__codelineno-35-73"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<a id="__codelineno-35-74" name="__codelineno-35-74"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">elements</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-75" name="__codelineno-35-75"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">mapper</span><span class="p">.</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">element</span><span class="p">));</span>
<a id="__codelineno-35-76" name="__codelineno-35-76"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-35-77" name="__codelineno-35-77"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-35-78" name="__codelineno-35-78"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 37-44 : test visuel. On affiche tous les utilisateurs avec leurs rôles ;</li>
<li>lignes 46-56 : on vérifie que l'utilisateur [admin] a le mot de passe [admin] et le  rôle [ROLE_ADMIN] en utilisant le repository [UserRepository] ;</li>
<li>ligne 51 : [admin] est le mot de passe en clair. En base, il est crypté selon l'algorithme BCrypt. La méthode [BCrypt.checkpw] permet de vérifier que le mot de passe en clair une fois crypté est bien égal à celui qui est en base ;</li>
<li>lignes 58-69 : on vérifie que l'utilisateur [admin] a le mot de passe [admin] et le  rôle [ROLE_ADMIN] en utilisant le service [appUserDetailsService] ;
L'exécution des tests réussit avec les logs suivants :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a>----------Utilisateur [{&quot;id&quot;:14,&quot;version&quot;:0,&quot;identity&quot;:&quot;admin&quot;,&quot;login&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;$2a$10$FN1LMKjPU46aPffh9Zaw4exJOLo51JJPWrxqzak/eJrbt3CO9WzVG&quot;}]
<a id="__codelineno-36-2" name="__codelineno-36-2"></a>Roles :
<a id="__codelineno-36-3" name="__codelineno-36-3"></a>{&quot;id&quot;:6,&quot;version&quot;:0,&quot;name&quot;:&quot;ROLE_ADMIN&quot;}
<a id="__codelineno-36-4" name="__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a>----------Utilisateur [{&quot;id&quot;:15,&quot;version&quot;:0,&quot;identity&quot;:&quot;user&quot;,&quot;login&quot;:&quot;user&quot;,&quot;password&quot;:&quot;$2a$10$SJehR9Mv2VdyRZo9F0rXa.hKAoGLhJg6kSdyfExi40mEJrNOj0BTq&quot;}]
<a id="__codelineno-36-6" name="__codelineno-36-6"></a>Roles :
<a id="__codelineno-36-7" name="__codelineno-36-7"></a>{&quot;id&quot;:7,&quot;version&quot;:0,&quot;name&quot;:&quot;ROLE_USER&quot;}
<a id="__codelineno-36-8" name="__codelineno-36-8"></a>
<a id="__codelineno-36-9" name="__codelineno-36-9"></a>----------Utilisateur [{&quot;id&quot;:16,&quot;version&quot;:0,&quot;identity&quot;:&quot;guest&quot;,&quot;login&quot;:&quot;guest&quot;,&quot;password&quot;:&quot;$2a$10$ubyWJb/vg2XZnUOAUjspZuz9jpHP3fIbPTbwQU115EtLdeSZ2PB7q&quot;}]
<a id="__codelineno-36-10" name="__codelineno-36-10"></a>Roles :
<a id="__codelineno-36-11" name="__codelineno-36-11"></a>{&quot;id&quot;:5,&quot;version&quot;:0,&quot;name&quot;:&quot;ROLE_GUEST&quot;}
<a id="__codelineno-36-12" name="__codelineno-36-12"></a>
<a id="__codelineno-36-13" name="__codelineno-36-13"></a>----------Utilisateur [{&quot;id&quot;:17,&quot;version&quot;:0,&quot;identity&quot;:&quot;x&quot;,&quot;login&quot;:&quot;x&quot;,&quot;password&quot;:&quot;$2a$10$kEXA56wpKHFReVqwQTyWguKguK8I4uhA2zb6t3wGxag8Dyv7AhLom&quot;}]
<a id="__codelineno-36-14" name="__codelineno-36-14"></a>Roles :
<a id="__codelineno-36-15" name="__codelineno-36-15"></a>{&quot;id&quot;:5,&quot;version&quot;:0,&quot;name&quot;:&quot;ROLE_GUEST&quot;}
</code></pre></div></td></tr></table></div>
<h3 id="1649-tests-du-service-web">16.4.9. Tests du service web</h3>
<p>Nous allons tester le service web avec le client Chrome [Advanced Rest Client]. Nous allons avoir besoin de préciser l'entête HTTP d'authentification :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a>Authorization:Basic code
</code></pre></div></td></tr></table></div>
<p>où [code] est le code Base64 de la chaîne [login:password]. Pour générer ce code, on peut utiliser le programme suivant :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000CD0000004D7F21C7F8.png" style="display:inline-block; margin:4px;width:3.799cm;height:1.431cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span>
<span class="normal"><a href="#__codelineno-38-13">13</a></span>
<span class="normal"><a href="#__codelineno-38-14">14</a></span>
<span class="normal"><a href="#__codelineno-38-15">15</a></span>
<span class="normal"><a href="#__codelineno-38-16">16</a></span>
<span class="normal"><a href="#__codelineno-38-17">17</a></span>
<span class="normal"><a href="#__codelineno-38-18">18</a></span>
<span class="normal"><a href="#__codelineno-38-19">19</a></span>
<span class="normal"><a href="#__codelineno-38-20">20</a></span>
<span class="normal"><a href="#__codelineno-38-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.helpers</span><span class="p">;</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.security.crypto.codec.Base64</span><span class="p">;</span>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Base64Encoder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">        </span><span class="c1">// on attend deux arguments : login password</span>
<a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Syntaxe : login password&quot;</span><span class="p">);</span>
<a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="w">        </span><span class="c1">// on récupère les deux arguments</span>
<a id="__codelineno-38-14" name="__codelineno-38-14"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">chaîne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s:%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">);</span>
<a id="__codelineno-38-15" name="__codelineno-38-15"></a><span class="w">        </span><span class="c1">// on encode la chaîne</span>
<a id="__codelineno-38-16" name="__codelineno-38-16"></a><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encode</span><span class="p">(</span><span class="n">chaîne</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
<a id="__codelineno-38-17" name="__codelineno-38-17"></a><span class="w">        </span><span class="c1">// on affiche son encodage Base64</span>
<a id="__codelineno-38-18" name="__codelineno-38-18"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<a id="__codelineno-38-19" name="__codelineno-38-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-38-20" name="__codelineno-38-20"></a>
<a id="__codelineno-38-21" name="__codelineno-38-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Si nous exécutons ce programme avec les deux arguments [admin admin] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000B600000082F93EB79F.png" style="display:inline-block; margin:4px;width:3.371cm;height:2.409cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>nous obtenons le résultat suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a>YWRtaW46YWRtaW4=
</code></pre></div></td></tr></table></div>
<p>Maintenant que nous savons générer l'entête HTTP d'authentification, nous lançons le service web sécurisé, puis avec le client Chrome [Advanced Rest Client], nous demandons la liste des tous les produits :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000452000001B0CCD29594.png" style="display:inline-block; margin:4px;width:14.631cm;height:5.715cm;" /></td></tr></table>

<ul>
<li>en [1], nous demandons l'URL des catégories ;</li>
<li>en [2], avec une méthode GET ;</li>
<li>en [3], nous donnons l'entête HTTP de l'authentification. Le code [YWRtaW46YWRtaW4=] est le codage Base64 de la chaîne [admin:admin] ;</li>
<li>en [4], nous envoyons la commande HTTP ;
La réponse du serveur est la suivante :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000002CE000001B5B729F0DF.png" style="display:inline-block; margin:4px;width:9.499cm;height:5.782cm;" /></td></tr></table>

<ul>
<li>en [1], l'entête HTTP d'authentification ;</li>
<li>en [2], le serveur renvoie une réponse jSON ;
On obtient bien la liste des catégories :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000119000001657189CC21.png" style="display:inline-block; margin:4px;width:5.2cm;height:6.609cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Tentons maintenant une requête HTTP avec un entête d'authentification incorrect. La réponse est alors la suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000417000001BAAC19A967.png" style="display:inline-block; margin:4px;width:13.852cm;height:5.847cm;" /></td></tr></table>

<ul>
<li>en [1] : l'entête HTTP d'authentification ;
Nous obtenons la réponse suivante :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000323000001EA481B75CA.png" style="display:inline-block; margin:4px;width:10.624cm;height:6.482cm;" /></td></tr></table>

<ul>
<li>en [2] : la réponse du service web ;
Maintenant, essayons l'utilisateur user / user. Il existe mais n'a pas accès au service web. Si nous exécutons le programme d'encodage Base64 avec les deux arguments [user user] :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000009E000000765D52ED73.png" style="display:inline-block; margin:4px;width:2.93cm;height:2.191cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>nous obtenons le résultat suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a>dXNlcjp1c2Vy
</code></pre></div></td></tr></table></div>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000002E20000011B5B418D52.png" style="display:inline-block; margin:4px;width:9.763cm;height:3.745cm;" /></td></tr></table>

<ul>
<li>en [1]  : l'entête HTTP d'authentification erroné ;</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000002AC000001CCB5568B61.png" style="display:inline-block; margin:4px;width:9.049cm;height:6.085cm;" /></td></tr></table>

<ul>
<li>en [2] : la réponse du service web. Elle est différente de la précédente qui était [401 Unauthorized]. Cette fois-ci, l'utilisateur s'est authentifié correctement mais n'a pas les droits suffisants pour accéder à l'URL ;
Notre service web sécurisé est désormais opérationnel.</li>
</ul>
<h3 id="16410-une-url-dauthentification">16.4.10. Une URL d'authentification</h3>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000117000000BAB751A9D8.png" style="display:inline-block; margin:4px;width:5.159cm;height:3.44cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<p>Nous allons créer une URL qui nous permettra de savoir si un utilisateur est autorisé ou non à accéder au service web. pour cela nous créons le nouveau contrôleur MVC [AuthenticateController] suivant :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-41-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-41-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-41-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-41-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-41-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-41-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-41-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-41-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-41-10">10</a></span>
<span class="normal"><a href="#__codelineno-41-11">11</a></span>
<span class="normal"><a href="#__codelineno-41-12">12</a></span>
<span class="normal"><a href="#__codelineno-41-13">13</a></span>
<span class="normal"><a href="#__codelineno-41-14">14</a></span>
<span class="normal"><a href="#__codelineno-41-15">15</a></span>
<span class="normal"><a href="#__codelineno-41-16">16</a></span>
<span class="normal"><a href="#__codelineno-41-17">17</a></span>
<span class="normal"><a href="#__codelineno-41-18">18</a></span>
<span class="normal"><a href="#__codelineno-41-19">19</a></span>
<span class="normal"><a href="#__codelineno-41-20">20</a></span>
<span class="normal"><a href="#__codelineno-41-21">21</a></span>
<span class="normal"><a href="#__codelineno-41-22">22</a></span>
<span class="normal"><a href="#__codelineno-41-23">23</a></span>
<span class="normal"><a href="#__codelineno-41-24">24</a></span>
<span class="normal"><a href="#__codelineno-41-25">25</a></span>
<span class="normal"><a href="#__codelineno-41-26">26</a></span>
<span class="normal"><a href="#__codelineno-41-27">27</a></span>
<span class="normal"><a href="#__codelineno-41-28">28</a></span>
<span class="normal"><a href="#__codelineno-41-29">29</a></span>
<span class="normal"><a href="#__codelineno-41-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.service</span><span class="p">;</span>
<a id="__codelineno-41-2" name="__codelineno-41-2"></a>
<a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.context.ApplicationContext</span><span class="p">;</span>
<a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.stereotype.Controller</span><span class="p">;</span>
<a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestMapping</span><span class="p">;</span>
<a id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.RequestMethod</span><span class="p">;</span>
<a id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.bind.annotation.ResponseBody</span><span class="p">;</span>
<a id="__codelineno-41-9" name="__codelineno-41-9"></a>
<a id="__codelineno-41-10" name="__codelineno-41-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.core.JsonProcessingException</span><span class="p">;</span>
<a id="__codelineno-41-11" name="__codelineno-41-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="p">;</span>
<a id="__codelineno-41-12" name="__codelineno-41-12"></a>
<a id="__codelineno-41-13" name="__codelineno-41-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.webjson.models.Response</span><span class="p">;</span>
<a id="__codelineno-41-14" name="__codelineno-41-14"></a>
<a id="__codelineno-41-15" name="__codelineno-41-15"></a><span class="nd">@Controller</span>
<a id="__codelineno-41-16" name="__codelineno-41-16"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthenticateController</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-17" name="__codelineno-41-17"></a>
<a id="__codelineno-41-18" name="__codelineno-41-18"></a><span class="w">    </span><span class="c1">// dépendances Spring</span>
<a id="__codelineno-41-19" name="__codelineno-41-19"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-41-20" name="__codelineno-41-20"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<a id="__codelineno-41-21" name="__codelineno-41-21"></a>
<a id="__codelineno-41-22" name="__codelineno-41-22"></a><span class="w">    </span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/authenticate&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestMethod</span><span class="p">.</span><span class="na">GET</span><span class="p">,</span><span class="w"> </span><span class="n">produces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;application/json; charset=UTF-8&quot;</span><span class="p">)</span>
<a id="__codelineno-41-23" name="__codelineno-41-23"></a><span class="w">    </span><span class="nd">@ResponseBody</span>
<a id="__codelineno-41-24" name="__codelineno-41-24"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-25" name="__codelineno-41-25"></a><span class="w">        </span><span class="c1">// réponse jSON</span>
<a id="__codelineno-41-26" name="__codelineno-41-26"></a><span class="w">        </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">mapperResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">ObjectMapper</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-41-27" name="__codelineno-41-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mapperResponse</span><span class="p">.</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">));</span>
<a id="__codelineno-41-28" name="__codelineno-41-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-41-29" name="__codelineno-41-29"></a>
<a id="__codelineno-41-30" name="__codelineno-41-30"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 15 : la classe [AuthenticateController] est un contrôleur Spring. A ce titre elle expose des URL ;</li>
<li>ligne 22 : expose l'URL [/authenticate] ;</li>
<li>ligne 23 : le résultat de la méthode sera envoyé directement au client ;</li>
<li>lignes 26-27 : la méthode se contente de renvoyer un objet [Response] vide mais avec un [status] égal à 0, montrant qu'il n'y a pas eu d'erreur ;
A quoi sert cette URL ? Lorsque nous voudrons simplement authentifier un utilisateur, nous la demanderons. Nous avons vu que si la couche de sécurité n'accepte pas cet utilisateur, elle renvoie une exception. Voici un exemple ;</li>
</ul>
<p>Avec l'utilisateur [admin:admin] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000001420000009AABCE08F9.png" style="display:inline-block; margin:4px;width:5.96cm;height:2.85cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/1000000000000117000000B591DBE78F.png" style="display:inline-block; margin:4px;width:5.159cm;height:3.35cm;" /></td></tr></table>

<p>On a une réponse vide mais pas d'exception.</p>
<p>Avec l'utilisateur [user:user] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000013400000092BD454689.png" style="display:inline-block; margin:4px;width:5.701cm;height:2.701cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000014B0000013AB01AB4A1.png" style="display:inline-block; margin:4px;width:6.13cm;height:5.81cm;" /></td></tr></table>

<p>On a eu une exception.</p>
<h3 id="16411-conclusion">16.4.11. Conclusion</h3>
<p>L'ajout des classes nécessaires à Spring Security a pu se faire sans modifications du projet web / json originel. Ce cas très favorable découle du fait que les trois tables ajoutées dans la base de données sont indépendantes des tables existantes. On aurait même pu les mettre dans une base de données séparée. Dans d'autres cas, les tables ajoutées peuvent avoir des relations avec les tables existantes. Il faut alors modifier les entités JPA ce qui en général impacte toutes les couches du projet.</p>
<h2 id="165-un-client-programme-pour-le-service-web-json-securise">16.5. Un client programmé pour le service web / jSON sécurisé</h2>
<p>Nous avons déjà écrit un client pour le service web / jSON non sécurisé :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000049C000003193CBC7635.png" style="display:inline-block; margin:4px;width:15.61cm;height:10.492cm;" /></td></tr></table>

<p>Nous allons maintenant créer un client programmé pour le service web sécurisé :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000046E0000030D137DB59E.png" style="display:inline-block; margin:4px;width:15.002cm;height:10.333cm;" /></td></tr></table>

<p>Nous dupliquons le projet déjà écrit [intro-webjson-client] dans un nouveau projet [intro-spring-security-client-01] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000F0000001C2A470D4AF.png" style="display:inline-block; margin:4px;width:4.45cm;height:8.331cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<h4 id="16501-la-classe-abstractdao">16.5.0.1. La classe [AbstractDao]</h4>
<p>La classe [AbstractDao] assure la communication HTTP avec le serveur web / jSON sécurisé. Comme nous venons de le voir, dans cette communication HTTP, le client doit désormais envoyer un entête d'authentification, par exemple :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a>Authorization:Basic YWRtaW46YWRtaW4=
</code></pre></div></td></tr></table></div>
<p>Cela se fait de la façon suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span>
<span class="normal"><a href="#__codelineno-43-11">11</a></span>
<span class="normal"><a href="#__codelineno-43-12">12</a></span>
<span class="normal"><a href="#__codelineno-43-13">13</a></span>
<span class="normal"><a href="#__codelineno-43-14">14</a></span>
<span class="normal"><a href="#__codelineno-43-15">15</a></span>
<span class="normal"><a href="#__codelineno-43-16">16</a></span>
<span class="normal"><a href="#__codelineno-43-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.client.dao</span><span class="p">;</span>
<a id="__codelineno-43-2" name="__codelineno-43-2"></a>
<a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URI</span><span class="p">;</span>
<a id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="p">...</span>
<a id="__codelineno-43-5" name="__codelineno-43-5"></a>
<a id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractDao</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-7" name="__codelineno-43-7"></a>
<a id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-43-10" name="__codelineno-43-10"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">;</span>
<a id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">urlServiceWebJson</span><span class="p">;</span>
<a id="__codelineno-43-13" name="__codelineno-43-13"></a>
<a id="__codelineno-43-14" name="__codelineno-43-14"></a><span class="w">    </span><span class="c1">// requête générique</span>
<a id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getResponse</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">jsonPost</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-16" name="__codelineno-43-16"></a>
<a id="__codelineno-43-17" name="__codelineno-43-17"></a><span class="c1">// url : URL à contacter</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 15 : la méthode générique [getResponse] en charge de la communication HTTP avec le service web sécurisé, admet désormais comme premier paramètre l'utilisateur qui demande une URL. La classe [User] est la suivante :
Cette classe est la suivante :</li>
</ul>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000E7000000C0BE8614F6.png" style="display:inline-block; margin:4px;width:4.279cm;height:3.56cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-44-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-44-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-44-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-44-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-44-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-44-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-44-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-44-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-44-10">10</a></span>
<span class="normal"><a href="#__codelineno-44-11">11</a></span>
<span class="normal"><a href="#__codelineno-44-12">12</a></span>
<span class="normal"><a href="#__codelineno-44-13">13</a></span>
<span class="normal"><a href="#__codelineno-44-14">14</a></span>
<span class="normal"><a href="#__codelineno-44-15">15</a></span>
<span class="normal"><a href="#__codelineno-44-16">16</a></span>
<span class="normal"><a href="#__codelineno-44-17">17</a></span>
<span class="normal"><a href="#__codelineno-44-18">18</a></span>
<span class="normal"><a href="#__codelineno-44-19">19</a></span>
<span class="normal"><a href="#__codelineno-44-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.client.entities</span><span class="p">;</span>
<a id="__codelineno-44-2" name="__codelineno-44-2"></a>
<a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-4" name="__codelineno-44-4"></a>
<a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="w">    </span><span class="c1">// propriétés</span>
<a id="__codelineno-44-6" name="__codelineno-44-6"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">login</span><span class="p">;</span>
<a id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-44-8" name="__codelineno-44-8"></a>
<a id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="w">    </span><span class="c1">// constructeur</span>
<a id="__codelineno-44-10" name="__codelineno-44-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">User</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-11" name="__codelineno-44-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-12" name="__codelineno-44-12"></a>
<a id="__codelineno-44-13" name="__codelineno-44-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">User</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">login</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-14" name="__codelineno-44-14"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">login</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">login</span><span class="p">;</span>
<a id="__codelineno-44-15" name="__codelineno-44-15"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">password</span><span class="p">;</span>
<a id="__codelineno-44-16" name="__codelineno-44-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-17" name="__codelineno-44-17"></a>
<a id="__codelineno-44-18" name="__codelineno-44-18"></a><span class="w">    </span><span class="c1">// getters et setters</span>
<a id="__codelineno-44-19" name="__codelineno-44-19"></a><span class="p">...</span>
<a id="__codelineno-44-20" name="__codelineno-44-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La méthode [getResponse] devient alors la suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-45-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-45-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-45-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-45-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-45-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-45-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-45-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-45-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-45-10">10</a></span>
<span class="normal"><a href="#__codelineno-45-11">11</a></span>
<span class="normal"><a href="#__codelineno-45-12">12</a></span>
<span class="normal"><a href="#__codelineno-45-13">13</a></span>
<span class="normal"><a href="#__codelineno-45-14">14</a></span>
<span class="normal"><a href="#__codelineno-45-15">15</a></span>
<span class="normal"><a href="#__codelineno-45-16">16</a></span>
<span class="normal"><a href="#__codelineno-45-17">17</a></span>
<span class="normal"><a href="#__codelineno-45-18">18</a></span>
<span class="normal"><a href="#__codelineno-45-19">19</a></span>
<span class="normal"><a href="#__codelineno-45-20">20</a></span>
<span class="normal"><a href="#__codelineno-45-21">21</a></span>
<span class="normal"><a href="#__codelineno-45-22">22</a></span>
<span class="normal"><a href="#__codelineno-45-23">23</a></span>
<span class="normal"><a href="#__codelineno-45-24">24</a></span>
<span class="normal"><a href="#__codelineno-45-25">25</a></span>
<span class="normal"><a href="#__codelineno-45-26">26</a></span>
<span class="normal"><a href="#__codelineno-45-27">27</a></span>
<span class="normal"><a href="#__codelineno-45-28">28</a></span>
<span class="normal"><a href="#__codelineno-45-29">29</a></span>
<span class="normal"><a href="#__codelineno-45-30">30</a></span>
<span class="normal"><a href="#__codelineno-45-31">31</a></span>
<span class="normal"><a href="#__codelineno-45-32">32</a></span>
<span class="normal"><a href="#__codelineno-45-33">33</a></span>
<span class="normal"><a href="#__codelineno-45-34">34</a></span>
<span class="normal"><a href="#__codelineno-45-35">35</a></span>
<span class="normal"><a href="#__codelineno-45-36">36</a></span>
<span class="normal"><a href="#__codelineno-45-37">37</a></span>
<span class="normal"><a href="#__codelineno-45-38">38</a></span>
<span class="normal"><a href="#__codelineno-45-39">39</a></span>
<span class="normal"><a href="#__codelineno-45-40">40</a></span>
<span class="normal"><a href="#__codelineno-45-41">41</a></span>
<span class="normal"><a href="#__codelineno-45-42">42</a></span>
<span class="normal"><a href="#__codelineno-45-43">43</a></span>
<span class="normal"><a href="#__codelineno-45-44">44</a></span>
<span class="normal"><a href="#__codelineno-45-45">45</a></span>
<span class="normal"><a href="#__codelineno-45-46">46</a></span>
<span class="normal"><a href="#__codelineno-45-47">47</a></span>
<span class="normal"><a href="#__codelineno-45-48">48</a></span>
<span class="normal"><a href="#__codelineno-45-49">49</a></span>
<span class="normal"><a href="#__codelineno-45-50">50</a></span>
<span class="normal"><a href="#__codelineno-45-51">51</a></span>
<span class="normal"><a href="#__codelineno-45-52">52</a></span>
<span class="normal"><a href="#__codelineno-45-53">53</a></span>
<span class="normal"><a href="#__codelineno-45-54">54</a></span>
<span class="normal"><a href="#__codelineno-45-55">55</a></span>
<span class="normal"><a href="#__codelineno-45-56">56</a></span>
<span class="normal"><a href="#__codelineno-45-57">57</a></span>
<span class="normal"><a href="#__codelineno-45-58">58</a></span>
<span class="normal"><a href="#__codelineno-45-59">59</a></span>
<span class="normal"><a href="#__codelineno-45-60">60</a></span>
<span class="normal"><a href="#__codelineno-45-61">61</a></span>
<span class="normal"><a href="#__codelineno-45-62">62</a></span>
<span class="normal"><a href="#__codelineno-45-63">63</a></span>
<span class="normal"><a href="#__codelineno-45-64">64</a></span>
<span class="normal"><a href="#__codelineno-45-65">65</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.client.dao</span><span class="p">;</span>
<a id="__codelineno-45-2" name="__codelineno-45-2"></a>
<a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URI</span><span class="p">;</span>
<a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URISyntaxException</span><span class="p">;</span>
<a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Base64</span><span class="p">;</span>
<a id="__codelineno-45-6" name="__codelineno-45-6"></a>
<a id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>
<a id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.core.ParameterizedTypeReference</span><span class="p">;</span>
<a id="__codelineno-45-9" name="__codelineno-45-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.MediaType</span><span class="p">;</span>
<a id="__codelineno-45-10" name="__codelineno-45-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.RequestEntity</span><span class="p">;</span>
<a id="__codelineno-45-11" name="__codelineno-45-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.RequestEntity.BodyBuilder</span><span class="p">;</span>
<a id="__codelineno-45-12" name="__codelineno-45-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.RequestEntity.HeadersBuilder</span><span class="p">;</span>
<a id="__codelineno-45-13" name="__codelineno-45-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.web.client.RestTemplate</span><span class="p">;</span>
<a id="__codelineno-45-14" name="__codelineno-45-14"></a>
<a id="__codelineno-45-15" name="__codelineno-45-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.client.entities.User</span><span class="p">;</span>
<a id="__codelineno-45-16" name="__codelineno-45-16"></a>
<a id="__codelineno-45-17" name="__codelineno-45-17"></a><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractDao</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-18" name="__codelineno-45-18"></a>
<a id="__codelineno-45-19" name="__codelineno-45-19"></a><span class="w">    </span><span class="c1">// data</span>
<a id="__codelineno-45-20" name="__codelineno-45-20"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-45-21" name="__codelineno-45-21"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">;</span>
<a id="__codelineno-45-22" name="__codelineno-45-22"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-45-23" name="__codelineno-45-23"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">urlServiceWebJson</span><span class="p">;</span>
<a id="__codelineno-45-24" name="__codelineno-45-24"></a>
<a id="__codelineno-45-25" name="__codelineno-45-25"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getBase64</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-26" name="__codelineno-45-26"></a><span class="w">        </span><span class="c1">// on encode en base 64 l&#39;utilisateur et son mot de passe - nécessite java 8</span>
<a id="__codelineno-45-27" name="__codelineno-45-27"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">chaîne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s:%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getLogin</span><span class="p">(),</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getPassword</span><span class="p">());</span>
<a id="__codelineno-45-28" name="__codelineno-45-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;Basic %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encode</span><span class="p">(</span><span class="n">chaîne</span><span class="p">.</span><span class="na">getBytes</span><span class="p">())));</span>
<a id="__codelineno-45-29" name="__codelineno-45-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-30" name="__codelineno-45-30"></a>
<a id="__codelineno-45-31" name="__codelineno-45-31"></a><span class="w">    </span><span class="c1">// requête générique</span>
<a id="__codelineno-45-32" name="__codelineno-45-32"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getResponse</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">jsonPost</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-33" name="__codelineno-45-33"></a>
<a id="__codelineno-45-34" name="__codelineno-45-34"></a><span class="w">        </span><span class="c1">// url : URL à contacter</span>
<a id="__codelineno-45-35" name="__codelineno-45-35"></a><span class="w">        </span><span class="c1">// jsonPost : la valeur jSON à poster</span>
<a id="__codelineno-45-36" name="__codelineno-45-36"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-37" name="__codelineno-45-37"></a><span class="w">            </span><span class="c1">// exécution requête</span>
<a id="__codelineno-45-38" name="__codelineno-45-38"></a><span class="w">            </span><span class="n">RequestEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">;</span>
<a id="__codelineno-45-39" name="__codelineno-45-39"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jsonPost</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-40" name="__codelineno-45-40"></a><span class="w">                </span><span class="n">HeadersBuilder</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">headersBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">URI</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">urlServiceWebJson</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">)))</span>
<a id="__codelineno-45-41" name="__codelineno-45-41"></a><span class="w">                        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">);</span>
<a id="__codelineno-45-42" name="__codelineno-45-42"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-43" name="__codelineno-45-43"></a><span class="w">                    </span><span class="n">headersBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">headersBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getBase64</span><span class="p">(</span><span class="n">user</span><span class="p">));</span>
<a id="__codelineno-45-44" name="__codelineno-45-44"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-45-45" name="__codelineno-45-45"></a><span class="w">                </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">headersBuilder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-45-46" name="__codelineno-45-46"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-47" name="__codelineno-45-47"></a><span class="w">                </span><span class="n">BodyBuilder</span><span class="w"> </span><span class="n">bodyBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestEntity</span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">URI</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">urlServiceWebJson</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p">)))</span>
<a id="__codelineno-45-48" name="__codelineno-45-48"></a><span class="w">                        </span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;application/json&quot;</span><span class="p">).</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">);</span>
<a id="__codelineno-45-49" name="__codelineno-45-49"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-50" name="__codelineno-45-50"></a><span class="w">                    </span><span class="n">bodyBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bodyBuilder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">getBase64</span><span class="p">(</span><span class="n">user</span><span class="p">));</span>
<a id="__codelineno-45-51" name="__codelineno-45-51"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-45-52" name="__codelineno-45-52"></a><span class="w">                </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bodyBuilder</span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">jsonPost</span><span class="p">);</span>
<a id="__codelineno-45-53" name="__codelineno-45-53"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-45-54" name="__codelineno-45-54"></a>
<a id="__codelineno-45-55" name="__codelineno-45-55"></a><span class="w">            </span><span class="c1">// on exécute la requête</span>
<a id="__codelineno-45-56" name="__codelineno-45-56"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">exchange</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ParameterizedTypeReference</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-57" name="__codelineno-45-57"></a><span class="w">            </span><span class="p">}).</span><span class="na">getBody</span><span class="p">();</span>
<a id="__codelineno-45-58" name="__codelineno-45-58"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">URISyntaxException</span><span class="w"> </span><span class="n">e1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-59" name="__codelineno-45-59"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DaoException</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">);</span>
<a id="__codelineno-45-60" name="__codelineno-45-60"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-61" name="__codelineno-45-61"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DaoException</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">);</span>
<a id="__codelineno-45-62" name="__codelineno-45-62"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-45-63" name="__codelineno-45-63"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-64" name="__codelineno-45-64"></a>
<a id="__codelineno-45-65" name="__codelineno-45-65"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lignes 42-44, 49-51 : si l'utilisateur [user] n'est pas <strong>null</strong>, alors on ajoute l'entête d'authentification. L'encodage Base64 de l'utilisateur et de son mot de passe est assuré par la méthode [getBase64] des lignes 25-29. On fera attention au fait que cette méthode utilise une classe [Base64] appartenant au JDK 1.8.</li>
<li>en-dehors des lignes précédentes, le code reste inchangé ;</li>
</ul>
<h4 id="16502-linterface-idao">16.5.0.2. L'interface [IDao]</h4>
<p>Toutes les méthodes de l'interface [IDao] reçoivent un paramètre supplémentaire [User user] :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/100000000000010B000000C9955EE9BE.png" style="display:inline-block; margin:4px;width:4.93cm;height:3.72cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span>
<span class="normal"><a href="#__codelineno-46-13">13</a></span>
<span class="normal"><a href="#__codelineno-46-14">14</a></span>
<span class="normal"><a href="#__codelineno-46-15">15</a></span>
<span class="normal"><a href="#__codelineno-46-16">16</a></span>
<span class="normal"><a href="#__codelineno-46-17">17</a></span>
<span class="normal"><a href="#__codelineno-46-18">18</a></span>
<span class="normal"><a href="#__codelineno-46-19">19</a></span>
<span class="normal"><a href="#__codelineno-46-20">20</a></span>
<span class="normal"><a href="#__codelineno-46-21">21</a></span>
<span class="normal"><a href="#__codelineno-46-22">22</a></span>
<span class="normal"><a href="#__codelineno-46-23">23</a></span>
<span class="normal"><a href="#__codelineno-46-24">24</a></span>
<span class="normal"><a href="#__codelineno-46-25">25</a></span>
<span class="normal"><a href="#__codelineno-46-26">26</a></span>
<span class="normal"><a href="#__codelineno-46-27">27</a></span>
<span class="normal"><a href="#__codelineno-46-28">28</a></span>
<span class="normal"><a href="#__codelineno-46-29">29</a></span>
<span class="normal"><a href="#__codelineno-46-30">30</a></span>
<span class="normal"><a href="#__codelineno-46-31">31</a></span>
<span class="normal"><a href="#__codelineno-46-32">32</a></span>
<span class="normal"><a href="#__codelineno-46-33">33</a></span>
<span class="normal"><a href="#__codelineno-46-34">34</a></span>
<span class="normal"><a href="#__codelineno-46-35">35</a></span>
<span class="normal"><a href="#__codelineno-46-36">36</a></span>
<span class="normal"><a href="#__codelineno-46-37">37</a></span>
<span class="normal"><a href="#__codelineno-46-38">38</a></span>
<span class="normal"><a href="#__codelineno-46-39">39</a></span>
<span class="normal"><a href="#__codelineno-46-40">40</a></span>
<span class="normal"><a href="#__codelineno-46-41">41</a></span>
<span class="normal"><a href="#__codelineno-46-42">42</a></span>
<span class="normal"><a href="#__codelineno-46-43">43</a></span>
<span class="normal"><a href="#__codelineno-46-44">44</a></span>
<span class="normal"><a href="#__codelineno-46-45">45</a></span>
<span class="normal"><a href="#__codelineno-46-46">46</a></span>
<span class="normal"><a href="#__codelineno-46-47">47</a></span>
<span class="normal"><a href="#__codelineno-46-48">48</a></span>
<span class="normal"><a href="#__codelineno-46-49">49</a></span>
<span class="normal"><a href="#__codelineno-46-50">50</a></span>
<span class="normal"><a href="#__codelineno-46-51">51</a></span>
<span class="normal"><a href="#__codelineno-46-52">52</a></span>
<span class="normal"><a href="#__codelineno-46-53">53</a></span>
<span class="normal"><a href="#__codelineno-46-54">54</a></span>
<span class="normal"><a href="#__codelineno-46-55">55</a></span>
<span class="normal"><a href="#__codelineno-46-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">spring.security.client.dao</span><span class="p">;</span>
<a id="__codelineno-46-2" name="__codelineno-46-2"></a>
<a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-46-4" name="__codelineno-46-4"></a>
<a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.client.entities.Categorie</span><span class="p">;</span>
<a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.client.entities.Produit</span><span class="p">;</span>
<a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">spring.security.client.entities.User</span><span class="p">;</span>
<a id="__codelineno-46-8" name="__codelineno-46-8"></a>
<a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">IDaoClient</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-10" name="__codelineno-46-10"></a>
<a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="w">    </span><span class="c1">// authentification</span>
<a id="__codelineno-46-12" name="__codelineno-46-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-46-13" name="__codelineno-46-13"></a>
<a id="__codelineno-46-14" name="__codelineno-46-14"></a><span class="w">    </span><span class="c1">// insertion d&#39;une liste de produits</span>
<a id="__codelineno-46-15" name="__codelineno-46-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">addProduits</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;</span><span class="w"> </span><span class="n">produits</span><span class="p">);</span>
<a id="__codelineno-46-16" name="__codelineno-46-16"></a>
<a id="__codelineno-46-17" name="__codelineno-46-17"></a><span class="w">    </span><span class="c1">// suppression de tous les produits</span>
<a id="__codelineno-46-18" name="__codelineno-46-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deleteAllProduits</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-46-19" name="__codelineno-46-19"></a>
<a id="__codelineno-46-20" name="__codelineno-46-20"></a><span class="w">    </span><span class="c1">// mise à jour d&#39;une liste de produits</span>
<a id="__codelineno-46-21" name="__codelineno-46-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">updateProduits</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;</span><span class="w"> </span><span class="n">produits</span><span class="p">);</span>
<a id="__codelineno-46-22" name="__codelineno-46-22"></a>
<a id="__codelineno-46-23" name="__codelineno-46-23"></a><span class="w">    </span><span class="c1">// obtention de tous les produits</span>
<a id="__codelineno-46-24" name="__codelineno-46-24"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllProduits</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-46-25" name="__codelineno-46-25"></a>
<a id="__codelineno-46-26" name="__codelineno-46-26"></a><span class="w">    </span><span class="c1">// insertion d&#39;une liste de categories</span>
<a id="__codelineno-46-27" name="__codelineno-46-27"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Categorie</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">addCategories</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Categorie</span><span class="o">&gt;</span><span class="w"> </span><span class="n">categories</span><span class="p">);</span>
<a id="__codelineno-46-28" name="__codelineno-46-28"></a>
<a id="__codelineno-46-29" name="__codelineno-46-29"></a><span class="w">    </span><span class="c1">// suppression de tous les categories</span>
<a id="__codelineno-46-30" name="__codelineno-46-30"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deleteAllCategories</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-46-31" name="__codelineno-46-31"></a>
<a id="__codelineno-46-32" name="__codelineno-46-32"></a><span class="w">    </span><span class="c1">// mise à jour d&#39;une liste de categories</span>
<a id="__codelineno-46-33" name="__codelineno-46-33"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Categorie</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">updateCategories</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Categorie</span><span class="o">&gt;</span><span class="w"> </span><span class="n">categories</span><span class="p">);</span>
<a id="__codelineno-46-34" name="__codelineno-46-34"></a>
<a id="__codelineno-46-35" name="__codelineno-46-35"></a><span class="w">    </span><span class="c1">// obtention de tous les categories</span>
<a id="__codelineno-46-36" name="__codelineno-46-36"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Categorie</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllCategories</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-46-37" name="__codelineno-46-37"></a>
<a id="__codelineno-46-38" name="__codelineno-46-38"></a><span class="w">    </span><span class="c1">// un produit particulier</span>
<a id="__codelineno-46-39" name="__codelineno-46-39"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Produit</span><span class="w"> </span><span class="nf">getProduitByIdWithCategorie</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">idProduit</span><span class="p">);</span>
<a id="__codelineno-46-40" name="__codelineno-46-40"></a>
<a id="__codelineno-46-41" name="__codelineno-46-41"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Produit</span><span class="w"> </span><span class="nf">getProduitByIdWithoutCategorie</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">idProduit</span><span class="p">);</span>
<a id="__codelineno-46-42" name="__codelineno-46-42"></a>
<a id="__codelineno-46-43" name="__codelineno-46-43"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Produit</span><span class="w"> </span><span class="nf">getProduitByNameWithCategorie</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nom</span><span class="p">);</span>
<a id="__codelineno-46-44" name="__codelineno-46-44"></a>
<a id="__codelineno-46-45" name="__codelineno-46-45"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Produit</span><span class="w"> </span><span class="nf">getProduitByNameWithoutCategorie</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nom</span><span class="p">);</span>
<a id="__codelineno-46-46" name="__codelineno-46-46"></a>
<a id="__codelineno-46-47" name="__codelineno-46-47"></a><span class="w">    </span><span class="c1">// une catégorie particulière</span>
<a id="__codelineno-46-48" name="__codelineno-46-48"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Categorie</span><span class="w"> </span><span class="nf">getCategorieByIdWithProduits</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">idCategorie</span><span class="p">);</span>
<a id="__codelineno-46-49" name="__codelineno-46-49"></a>
<a id="__codelineno-46-50" name="__codelineno-46-50"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Categorie</span><span class="w"> </span><span class="nf">getCategorieByIdWithoutProduits</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">idCategorie</span><span class="p">);</span>
<a id="__codelineno-46-51" name="__codelineno-46-51"></a>
<a id="__codelineno-46-52" name="__codelineno-46-52"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Categorie</span><span class="w"> </span><span class="nf">getCategorieByNameWithProduits</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nom</span><span class="p">);</span>
<a id="__codelineno-46-53" name="__codelineno-46-53"></a>
<a id="__codelineno-46-54" name="__codelineno-46-54"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Categorie</span><span class="w"> </span><span class="nf">getCategorieByNameWithoutProduits</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">nom</span><span class="p">);</span>
<a id="__codelineno-46-55" name="__codelineno-46-55"></a>
<a id="__codelineno-46-56" name="__codelineno-46-56"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>ligne 12 : nous avons ajouté la méthode [authenticate(User user)] pour authentifier un utilisateur. Elle lance une exception si l'utilsateur n'a pas le droit d'accéder à l'URL [/authenticate] du service web ;</li>
</ul>
<h4 id="16503-la-classe-dao">16.5.0.3. La classe [Dao]</h4>
<p>Toutes les méthodes de la classe [Dao] reçoivent un paramètre supplémentaire [User user] qu'elles passent à la méthode générique [getResponse] de la classe [AbstractDao]. Voici deux exemples :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-47-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-47-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-47-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-47-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-47-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-47-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-47-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-47-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-47-10">10</a></span>
<span class="normal"><a href="#__codelineno-47-11">11</a></span>
<span class="normal"><a href="#__codelineno-47-12">12</a></span>
<span class="normal"><a href="#__codelineno-47-13">13</a></span>
<span class="normal"><a href="#__codelineno-47-14">14</a></span>
<span class="normal"><a href="#__codelineno-47-15">15</a></span>
<span class="normal"><a href="#__codelineno-47-16">16</a></span>
<span class="normal"><a href="#__codelineno-47-17">17</a></span>
<span class="normal"><a href="#__codelineno-47-18">18</a></span>
<span class="normal"><a href="#__codelineno-47-19">19</a></span>
<span class="normal"><a href="#__codelineno-47-20">20</a></span>
<span class="normal"><a href="#__codelineno-47-21">21</a></span>
<span class="normal"><a href="#__codelineno-47-22">22</a></span>
<span class="normal"><a href="#__codelineno-47-23">23</a></span>
<span class="normal"><a href="#__codelineno-47-24">24</a></span>
<span class="normal"><a href="#__codelineno-47-25">25</a></span>
<span class="normal"><a href="#__codelineno-47-26">26</a></span>
<span class="normal"><a href="#__codelineno-47-27">27</a></span>
<span class="normal"><a href="#__codelineno-47-28">28</a></span>
<span class="normal"><a href="#__codelineno-47-29">29</a></span>
<span class="normal"><a href="#__codelineno-47-30">30</a></span>
<span class="normal"><a href="#__codelineno-47-31">31</a></span>
<span class="normal"><a href="#__codelineno-47-32">32</a></span>
<span class="normal"><a href="#__codelineno-47-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="c1">// authentification</span>
<a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="w">        </span><span class="n">getResponse</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/authenticate&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-47-6" name="__codelineno-47-6"></a>
<a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">addProduits</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;</span><span class="w"> </span><span class="n">produits</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="w">        </span><span class="c1">// ----------- ajouter des produits (sans leur catégorie)</span>
<a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-11" name="__codelineno-47-11"></a><span class="w">            </span><span class="c1">// mappeurs jSON</span>
<a id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="w">            </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">mapperPost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">ObjectMapper</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-47-13" name="__codelineno-47-13"></a><span class="w">            </span><span class="n">mapperPost</span><span class="p">.</span><span class="na">setFilters</span><span class="p">(</span><span class="n">jsonFilterProduitWithoutCategorie</span><span class="p">);</span>
<a id="__codelineno-47-14" name="__codelineno-47-14"></a><span class="w">            </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">mapperResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapperPost</span><span class="p">;</span>
<a id="__codelineno-47-15" name="__codelineno-47-15"></a><span class="w">            </span><span class="c1">// requête</span>
<a id="__codelineno-47-16" name="__codelineno-47-16"></a><span class="w">            </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapperResponse</span><span class="p">.</span><span class="na">readValue</span><span class="p">(</span>
<a id="__codelineno-47-17" name="__codelineno-47-17"></a><span class="w">                    </span><span class="n">getResponse</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/addProduits&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mapperPost</span><span class="p">.</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">produits</span><span class="p">)),</span>
<a id="__codelineno-47-18" name="__codelineno-47-18"></a><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;&gt;&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-19" name="__codelineno-47-19"></a><span class="w">                    </span><span class="p">});</span>
<a id="__codelineno-47-20" name="__codelineno-47-20"></a><span class="w">            </span><span class="c1">// erreur ?</span>
<a id="__codelineno-47-21" name="__codelineno-47-21"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-22" name="__codelineno-47-22"></a><span class="w">                </span><span class="c1">// on lance 1 exception</span>
<a id="__codelineno-47-23" name="__codelineno-47-23"></a><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DaoException</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatus</span><span class="p">(),</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getMessages</span><span class="p">());</span>
<a id="__codelineno-47-24" name="__codelineno-47-24"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-25" name="__codelineno-47-25"></a><span class="w">                </span><span class="c1">// on rend le coeur de la réponse du serveur</span>
<a id="__codelineno-47-26" name="__codelineno-47-26"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getBody</span><span class="p">();</span>
<a id="__codelineno-47-27" name="__codelineno-47-27"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-47-28" name="__codelineno-47-28"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">DaoException</span><span class="w"> </span><span class="n">e1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-29" name="__codelineno-47-29"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">e1</span><span class="p">;</span>
<a id="__codelineno-47-30" name="__codelineno-47-30"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-31" name="__codelineno-47-31"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DaoException</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">e2</span><span class="p">);</span>
<a id="__codelineno-47-32" name="__codelineno-47-32"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-47-33" name="__codelineno-47-33"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="16504-tests-unitaires-de-la-classe-dao">16.5.0.4. Tests unitaires de la classe [Dao]</h4>
<p>La classe [Test01] de tests unitaires de la classe [Dao] est modifiée de la façon suivante :</p>
<table class="odt-table" style="border-collapse: collapse; width: 100%; margin-bottom: 1em;"><tr><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;"><img src="images/10000000000000F900000093E26E8850.png" style="display:inline-block; margin:4px;width:4.611cm;height:2.72cm;" /></td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td><td style="border: 1px solid #ddd; padding: 8px; vertical-align: top;">&nbsp;</td></tr></table>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1">  1</a></span>
<span class="normal"><a href="#__codelineno-48-2">  2</a></span>
<span class="normal"><a href="#__codelineno-48-3">  3</a></span>
<span class="normal"><a href="#__codelineno-48-4">  4</a></span>
<span class="normal"><a href="#__codelineno-48-5">  5</a></span>
<span class="normal"><a href="#__codelineno-48-6">  6</a></span>
<span class="normal"><a href="#__codelineno-48-7">  7</a></span>
<span class="normal"><a href="#__codelineno-48-8">  8</a></span>
<span class="normal"><a href="#__codelineno-48-9">  9</a></span>
<span class="normal"><a href="#__codelineno-48-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-48-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-48-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-48-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-48-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-48-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-48-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-48-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-48-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-48-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-48-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-48-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-48-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-48-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-48-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-48-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-48-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-48-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-48-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-48-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-48-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-48-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-48-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-48-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-48-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-48-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-48-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-48-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-48-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-48-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-48-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-48-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-48-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-48-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-48-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-48-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-48-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-48-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-48-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-48-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-48-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-48-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-48-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-48-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-48-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-48-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-48-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-48-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-48-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-48-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-48-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-48-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-48-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-48-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-48-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-48-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-48-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-48-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-48-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-48-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-48-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-48-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-48-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-48-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-48-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-48-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-48-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-48-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-48-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-48-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-48-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-48-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-48-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-48-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-48-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-48-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-48-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-48-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-48-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-48-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-48-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-48-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-48-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-48-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-48-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-48-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-48-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-48-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-48-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-48-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-48-100">100</a></span>
<span class="normal"><a href="#__codelineno-48-101">101</a></span>
<span class="normal"><a href="#__codelineno-48-102">102</a></span>
<span class="normal"><a href="#__codelineno-48-103">103</a></span>
<span class="normal"><a href="#__codelineno-48-104">104</a></span>
<span class="normal"><a href="#__codelineno-48-105">105</a></span>
<span class="normal"><a href="#__codelineno-48-106">106</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">client.tests.junit</span><span class="p">;</span>
<a id="__codelineno-48-2" name="__codelineno-48-2"></a>
<a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="p">...</span>
<a id="__codelineno-48-4" name="__codelineno-48-4"></a>
<a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="nd">@SpringApplicationConfiguration</span><span class="p">(</span><span class="n">classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DaoConfig</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="nd">@RunWith</span><span class="p">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Test01</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-8" name="__codelineno-48-8"></a>
<a id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="w">    </span><span class="c1">// contexte Spring</span>
<a id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<a id="__codelineno-48-12" name="__codelineno-48-12"></a><span class="w">    </span><span class="c1">// couche [DAO]</span>
<a id="__codelineno-48-13" name="__codelineno-48-13"></a><span class="w">    </span><span class="nd">@Autowired</span>
<a id="__codelineno-48-14" name="__codelineno-48-14"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">IDaoClient</span><span class="w"> </span><span class="n">dao</span><span class="p">;</span>
<a id="__codelineno-48-15" name="__codelineno-48-15"></a>
<a id="__codelineno-48-16" name="__codelineno-48-16"></a><span class="w">    </span><span class="c1">// utilisateurs</span>
<a id="__codelineno-48-17" name="__codelineno-48-17"></a><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">admin</span><span class="p">;</span>
<a id="__codelineno-48-18" name="__codelineno-48-18"></a><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>
<a id="__codelineno-48-19" name="__codelineno-48-19"></a><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">unknown</span><span class="p">;</span>
<a id="__codelineno-48-20" name="__codelineno-48-20"></a>
<a id="__codelineno-48-21" name="__codelineno-48-21"></a><span class="w">    </span><span class="nd">@BeforeClass</span>
<a id="__codelineno-48-22" name="__codelineno-48-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-23" name="__codelineno-48-23"></a><span class="w">        </span><span class="n">admin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;admin&quot;</span><span class="p">);</span>
<a id="__codelineno-48-24" name="__codelineno-48-24"></a><span class="w">        </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">);</span>
<a id="__codelineno-48-25" name="__codelineno-48-25"></a><span class="w">        </span><span class="n">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">User</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p">);</span>
<a id="__codelineno-48-26" name="__codelineno-48-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-27" name="__codelineno-48-27"></a>
<a id="__codelineno-48-28" name="__codelineno-48-28"></a><span class="w">    </span><span class="nd">@Before</span>
<a id="__codelineno-48-29" name="__codelineno-48-29"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cleanAndFill</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-30" name="__codelineno-48-30"></a><span class="w">        </span><span class="c1">// on nettoie la base avant chaque test</span>
<a id="__codelineno-48-31" name="__codelineno-48-31"></a><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Vidage de la base de données&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-48-32" name="__codelineno-48-32"></a><span class="w">        </span><span class="c1">// on vide la table [CATEGORIES] - par cascade la table [PRODUITS] va être vidée</span>
<a id="__codelineno-48-33" name="__codelineno-48-33"></a><span class="w">        </span><span class="n">dao</span><span class="p">.</span><span class="na">deleteAllCategories</span><span class="p">(</span><span class="n">admin</span><span class="p">);</span>
<a id="__codelineno-48-34" name="__codelineno-48-34"></a><span class="w">        </span><span class="c1">// --------------------------------------------------------------------------------------</span>
<a id="__codelineno-48-35" name="__codelineno-48-35"></a><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Remplissage de la base&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-48-36" name="__codelineno-48-36"></a><span class="w">        </span><span class="c1">// on remplit les tables</span>
<a id="__codelineno-48-37" name="__codelineno-48-37"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Categorie</span><span class="o">&gt;</span><span class="w"> </span><span class="n">categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Categorie</span><span class="o">&gt;</span><span class="p">();</span>
<a id="__codelineno-48-38" name="__codelineno-48-38"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-39" name="__codelineno-48-39"></a><span class="w">            </span><span class="n">Categorie</span><span class="w"> </span><span class="n">categorie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Categorie</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;categorie%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">));</span>
<a id="__codelineno-48-40" name="__codelineno-48-40"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-41" name="__codelineno-48-41"></a><span class="w">                </span><span class="n">categorie</span><span class="p">.</span><span class="na">addProduit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Produit</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;produit%d%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100</span><span class="p">),</span>
<a id="__codelineno-48-42" name="__codelineno-48-42"></a><span class="w">                        </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;desc%d%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">)));</span>
<a id="__codelineno-48-43" name="__codelineno-48-43"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-48-44" name="__codelineno-48-44"></a><span class="w">            </span><span class="n">categories</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">categorie</span><span class="p">);</span>
<a id="__codelineno-48-45" name="__codelineno-48-45"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-48-46" name="__codelineno-48-46"></a><span class="w">        </span><span class="c1">// ajout de la catégorie - par cascade les produits vont eux aussi être insérés</span>
<a id="__codelineno-48-47" name="__codelineno-48-47"></a><span class="w">        </span><span class="n">dao</span><span class="p">.</span><span class="na">addCategories</span><span class="p">(</span><span class="n">admin</span><span class="p">,</span><span class="w"> </span><span class="n">categories</span><span class="p">);</span>
<a id="__codelineno-48-48" name="__codelineno-48-48"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-49" name="__codelineno-48-49"></a>
<a id="__codelineno-48-50" name="__codelineno-48-50"></a><span class="w">    </span><span class="nd">@Test</span>
<a id="__codelineno-48-51" name="__codelineno-48-51"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">showDataBase</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="p">,</span><span class="w"> </span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-52" name="__codelineno-48-52"></a><span class="w">        </span><span class="c1">// liste des catégories</span>
<a id="__codelineno-48-53" name="__codelineno-48-53"></a><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Liste des catégories&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-48-54" name="__codelineno-48-54"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Categorie</span><span class="o">&gt;</span><span class="w"> </span><span class="n">categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="na">getAllCategories</span><span class="p">(</span><span class="n">admin</span><span class="p">);</span>
<a id="__codelineno-48-55" name="__codelineno-48-55"></a><span class="w">        </span><span class="n">affiche</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;jsonMapperCategorieWithoutProduits&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
<a id="__codelineno-48-56" name="__codelineno-48-56"></a><span class="w">        </span><span class="c1">// liste des produits</span>
<a id="__codelineno-48-57" name="__codelineno-48-57"></a><span class="w">        </span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Liste des produits&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-48-58" name="__codelineno-48-58"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Produit</span><span class="o">&gt;</span><span class="w"> </span><span class="n">produits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dao</span><span class="p">.</span><span class="na">getAllProduits</span><span class="p">(</span><span class="n">admin</span><span class="p">);</span>
<a id="__codelineno-48-59" name="__codelineno-48-59"></a><span class="w">        </span><span class="n">affiche</span><span class="p">(</span><span class="n">produits</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;jsonMapperProduitWithoutCategorie&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
<a id="__codelineno-48-60" name="__codelineno-48-60"></a><span class="w">        </span><span class="c1">// quelques vérifications</span>
<a id="__codelineno-48-61" name="__codelineno-48-61"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">categories</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
<a id="__codelineno-48-62" name="__codelineno-48-62"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">produits</span><span class="p">.</span><span class="na">size</span><span class="p">());</span>
<a id="__codelineno-48-63" name="__codelineno-48-63"></a><span class="w">        </span><span class="n">Categorie</span><span class="w"> </span><span class="n">categorie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findCategorieByName</span><span class="p">(</span><span class="s">&quot;categorie0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">categories</span><span class="p">);</span>
<a id="__codelineno-48-64" name="__codelineno-48-64"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertNotNull</span><span class="p">(</span><span class="n">categorie</span><span class="p">);</span>
<a id="__codelineno-48-65" name="__codelineno-48-65"></a><span class="w">        </span><span class="n">Produit</span><span class="w"> </span><span class="n">produit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findProduitByName</span><span class="p">(</span><span class="s">&quot;produit03&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">produits</span><span class="p">);</span>
<a id="__codelineno-48-66" name="__codelineno-48-66"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertNotNull</span><span class="p">(</span><span class="n">produit</span><span class="p">);</span>
<a id="__codelineno-48-67" name="__codelineno-48-67"></a><span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">idCategorie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">produit</span><span class="p">.</span><span class="na">getIdCategorie</span><span class="p">();</span>
<a id="__codelineno-48-68" name="__codelineno-48-68"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="n">categorie</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">idCategorie</span><span class="p">);</span>
<a id="__codelineno-48-69" name="__codelineno-48-69"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-70" name="__codelineno-48-70"></a><span class="p">...</span>
<a id="__codelineno-48-71" name="__codelineno-48-71"></a><span class="w">    </span><span class="nd">@Test</span><span class="p">()</span>
<a id="__codelineno-48-72" name="__codelineno-48-72"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkUserUser</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-73" name="__codelineno-48-73"></a><span class="w">        </span><span class="n">ServiceException</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-48-74" name="__codelineno-48-74"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-75" name="__codelineno-48-75"></a><span class="w">            </span><span class="n">dao</span><span class="p">.</span><span class="na">authenticate</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-48-76" name="__codelineno-48-76"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServiceException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-77" name="__codelineno-48-77"></a><span class="w">            </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="__codelineno-48-78" name="__codelineno-48-78"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-48-79" name="__codelineno-48-79"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertNotNull</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<a id="__codelineno-48-80" name="__codelineno-48-80"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="s">&quot;403 Forbidden&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">.</span><span class="na">getMessages</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<a id="__codelineno-48-81" name="__codelineno-48-81"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-82" name="__codelineno-48-82"></a>
<a id="__codelineno-48-83" name="__codelineno-48-83"></a><span class="w">    </span><span class="nd">@Test</span><span class="p">()</span>
<a id="__codelineno-48-84" name="__codelineno-48-84"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkUserUnknown</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-85" name="__codelineno-48-85"></a><span class="w">        </span><span class="n">ServiceException</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-48-86" name="__codelineno-48-86"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-87" name="__codelineno-48-87"></a><span class="w">            </span><span class="n">dao</span><span class="p">.</span><span class="na">authenticate</span><span class="p">(</span><span class="n">unknown</span><span class="p">);</span>
<a id="__codelineno-48-88" name="__codelineno-48-88"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServiceException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-89" name="__codelineno-48-89"></a><span class="w">            </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="__codelineno-48-90" name="__codelineno-48-90"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-48-91" name="__codelineno-48-91"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertNotNull</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<a id="__codelineno-48-92" name="__codelineno-48-92"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="s">&quot;401 Unauthorized&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">se</span><span class="p">.</span><span class="na">getMessages</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<a id="__codelineno-48-93" name="__codelineno-48-93"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-94" name="__codelineno-48-94"></a>
<a id="__codelineno-48-95" name="__codelineno-48-95"></a><span class="w">    </span><span class="nd">@Test</span><span class="p">()</span>
<a id="__codelineno-48-96" name="__codelineno-48-96"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">checkUserAdmin</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-97" name="__codelineno-48-97"></a><span class="w">        </span><span class="n">ServiceException</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-48-98" name="__codelineno-48-98"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-99" name="__codelineno-48-99"></a><span class="w">            </span><span class="n">dao</span><span class="p">.</span><span class="na">authenticate</span><span class="p">(</span><span class="n">admin</span><span class="p">);</span>
<a id="__codelineno-48-100" name="__codelineno-48-100"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServiceException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-101" name="__codelineno-48-101"></a><span class="w">            </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">;</span>
<a id="__codelineno-48-102" name="__codelineno-48-102"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-48-103" name="__codelineno-48-103"></a><span class="w">        </span><span class="n">Assert</span><span class="p">.</span><span class="na">assertNull</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>
<a id="__codelineno-48-104" name="__codelineno-48-104"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-48-105" name="__codelineno-48-105"></a><span class="p">...</span>
<a id="__codelineno-48-106" name="__codelineno-48-106"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ul>
<li>lors de l'initialisation de la classe de test, lignes 21-26, trois utilisateurs sont créés :</li>
<li>l'utilisateur [admin] a accès aux URL du service web, test lignes 96-104 ;</li>
<li>l'utilisateur [user] existe mais n'est pas autorisé à utiliser les URL du service web, test lignes 71-81 ;</li>
<li>l'utilisateur [unknown] n'existe pas, test lignes 83-93 ;</li>
<li>les méthodes de tests sont celles déjà vues pour le service web non sécurisé, si ce n'est que les méthodes de l'interface [IDaoClient] sont appelées avec comme premier paramètre, l'utilisateur [admin] qui a le droit d'utiliser les URL ;
Le test passe mais on peut constater qu'il est plus lent qu'avec le service web non sécurisé. La sécurisation d'une application augmente sensiblement ses temps de réponse. On peut noter un facteur important dans les performances du service web sécurisé : dans la classe [AppConfig] qui le configure, nous avons écrit :</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span>
<span class="normal"><a href="#__codelineno-49-16">16</a></span>
<span class="normal"><a href="#__codelineno-49-17">17</a></span>
<span class="normal"><a href="#__codelineno-49-18">18</a></span>
<span class="normal"><a href="#__codelineno-49-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="w">        </span><span class="c1">// CSRF</span>
<a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="w">        </span><span class="n">http</span><span class="p">.</span><span class="na">csrf</span><span class="p">().</span><span class="na">disable</span><span class="p">();</span>
<a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w">        </span><span class="c1">// application sécurisée ?</span>
<a id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activateSecurity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="w">            </span><span class="c1">// le mot de passe est transmis par le header Authorization: Basic xxxx</span>
<a id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="w">            </span><span class="n">http</span><span class="p">.</span><span class="na">httpBasic</span><span class="p">();</span>
<a id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="w">            </span><span class="c1">// la méthode HTTP OPTIONS doit être autorisée pour tous</span>
<a id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="w">            </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span><span class="w"> </span><span class="c1">//</span>
<a id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="w">                    </span><span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="n">HttpMethod</span><span class="p">.</span><span class="na">OPTIONS</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/**&quot;</span><span class="p">).</span><span class="na">permitAll</span><span class="p">();</span>
<a id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="w">            </span><span class="c1">// seul le rôle ADMIN peut utiliser l&#39;application</span>
<a id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="w">            </span><span class="n">http</span><span class="p">.</span><span class="na">authorizeRequests</span><span class="p">()</span><span class="w"> </span><span class="c1">//</span>
<a id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="w">                    </span><span class="p">.</span><span class="na">antMatchers</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/**&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// toutes les URL</span>
<a id="__codelineno-49-15" name="__codelineno-49-15"></a><span class="w">                    </span><span class="p">.</span><span class="na">hasRole</span><span class="p">(</span><span class="s">&quot;ADMIN&quot;</span><span class="p">);</span>
<a id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="w">            </span><span class="c1">// pas de session</span>
<a id="__codelineno-49-17" name="__codelineno-49-17"></a><span class="w">            </span><span class="n">http</span><span class="p">.</span><span class="na">sessionManagement</span><span class="p">().</span><span class="na">sessionCreationPolicy</span><span class="p">(</span><span class="n">SessionCreationPolicy</span><span class="p">.</span><span class="na">STATELESS</span><span class="p">);</span>
<a id="__codelineno-49-18" name="__codelineno-49-18"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-49-19" name="__codelineno-49-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>La ligne 17 a un coût. Elle force l'utilisateur à s'authentifier à chaque accès. Si on la met en commentaires, la durée du test JUnit précédent passe de 10,57 secondes à 4,21 secondes, ceci parce que l'utilisateur [admin] ne s'authentifie que pour le premier test et pas pour les suivants (même si l'entête HTTP d'authentification est envoyé par le client, le serveur lui ne revérifie pas le mot de passe de l'utilisateur). Avec un service web non sécurisé, la durée du test JUnit tombe à 2,33 secondes.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner">

      <div>
        <a href="https://tahe.developpez.com" target="_blank">
          https://tahe.developpez.com
        </a>
        <br>
        Ce cours tutoriel écrit par <strong>Serge Tahé</strong> est mis à disposition du public selon les termes de la
        <em>Licence Creative Commons Attribution – Pas d’Utilisation Commerciale –
        Partage dans les Mêmes Conditions 3.0 non transposé</em>.
      </div>

    </div>
  </div>

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": ".", "features": ["navigation.sections", "navigation.indexes", "toc.integrate", "navigation.top"], "search": "assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="javascripts/focus.js"></script>
      
    
  </body>
</html>